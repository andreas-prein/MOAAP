

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MOAAP: Multi-Object Analysis of Atmospheric Phenomena - Tutorial &mdash; MOAAP  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="MOAAP Reference" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            MOAAP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="modules.html">MOAAP Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MOAAP: Multi-Object Analysis of Atmospheric Phenomena - Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Part-1:-Running-MOAAP-on-Real-Data">Part 1: Running MOAAP on Real Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Run-the-Tracking">Run the Tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Visualize-Results">Visualize Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Part-1.2:-Run-with-full-dataset-and-analyze">Part 1.2: Run with full dataset and analyze</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Part-2:-Watershedding-Algorithm-Test">Part 2: Watershedding Algorithm Test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Run-Watershedding">Run Watershedding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Visualization-and-Comparison">Visualization and Comparison</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MOAAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">MOAAP: Multi-Object Analysis of Atmospheric Phenomena - Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="MOAAP:-Multi-Object-Analysis-of-Atmospheric-Phenomena---Tutorial">
<h1>MOAAP: Multi-Object Analysis of Atmospheric Phenomena - Tutorial<a class="headerlink" href="#MOAAP:-Multi-Object-Analysis-of-Atmospheric-Phenomena---Tutorial" title="Link to this heading"></a></h1>
<p>This notebook demonstrates the usage of the MOAAP tracking algorithm. It is divided into two parts:</p>
<ol class="arabic simple">
<li><p><strong>Standard Workflow</strong>: Running MOAAP on real atmospheric data (ERA5 sample) to identify phenomena like MCSs.</p></li>
<li><p><strong>Algorithm Deep-Dive</strong>: Testing the core segmentation algorithm (Watershedding) on idealized synthetic data to understand how objects are defined in 2D vs 3D.</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#!pip install git+https://github.com/andreas-prein/MOAAP.git # (only if the package is not already installed)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Defaulting to user installation because normal site-packages is not writeable
<span class="ansi-yellow-fg">DEPRECATION: Loading egg at /glade/u/home/prein/MyPython_Programs/python/packages/cdo-1.2.1/lib/python2.7/site-packages/cdo-1.2.1-py2.7.egg is deprecated. pip 25.1 will enforce this behaviour change. A possible replacement is to use pip for package installation. Discussion can be found at https://github.com/pypa/pip/issues/12330</span><span class="ansi-yellow-fg">
</span>Collecting git+https://github.com/andreas-prein/MOAAP.git
  Cloning https://github.com/andreas-prein/MOAAP.git to /glade/derecho/scratch/prein/tmp/pip-req-build-tjs92rnu
  Running command git clone --filter=blob:none --quiet https://github.com/andreas-prein/MOAAP.git /glade/derecho/scratch/prein/tmp/pip-req-build-tjs92rnu
  Resolved https://github.com/andreas-prein/MOAAP.git to commit a419659e97d59747576ef1535b90f4e8b09a85fb
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Requirement already satisfied: numpy in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (1.26.4)
Requirement already satisfied: scipy in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (1.15.1)
Requirement already satisfied: matplotlib in /glade/u/home/prein/.local/lib/python3.12/site-packages (from moaap==0.1.0) (3.8.4)
Requirement already satisfied: netCDF4 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (1.7.2)
Requirement already satisfied: xarray in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (2025.1.1)
Requirement already satisfied: pandas in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (2.2.3)
Requirement already satisfied: tqdm in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (4.67.1)
Requirement already satisfied: scikit-image in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (0.25.1)
Requirement already satisfied: cartopy in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (0.24.0)
Requirement already satisfied: shapely in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (2.0.6)
Requirement already satisfied: psutil in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (6.1.1)
Requirement already satisfied: metpy in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from moaap==0.1.0) (1.6.3)
Requirement already satisfied: packaging&gt;=21 in /glade/u/home/prein/.local/lib/python3.12/site-packages (from cartopy-&gt;moaap==0.1.0) (26.0)
Requirement already satisfied: pyshp&gt;=2.3 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from cartopy-&gt;moaap==0.1.0) (2.3.1)
Requirement already satisfied: pyproj&gt;=3.3.1 in /glade/u/home/prein/.local/lib/python3.12/site-packages (from cartopy-&gt;moaap==0.1.0) (3.6.1)
Requirement already satisfied: contourpy&gt;=1.0.1 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (1.3.1)
Requirement already satisfied: cycler&gt;=0.10 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (4.55.6)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (1.4.8)
Requirement already satisfied: pillow&gt;=8 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (11.1.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (3.2.1)
Requirement already satisfied: python-dateutil&gt;=2.7 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from matplotlib-&gt;moaap==0.1.0) (2.9.0.post0)
Requirement already satisfied: pint&gt;=0.17 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from metpy-&gt;moaap==0.1.0) (0.24.4)
Requirement already satisfied: pooch&gt;=1.2.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from metpy-&gt;moaap==0.1.0) (1.8.2)
Requirement already satisfied: traitlets&gt;=5.0.5 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from metpy-&gt;moaap==0.1.0) (5.14.3)
Requirement already satisfied: pytz&gt;=2020.1 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pandas-&gt;moaap==0.1.0) (2024.1)
Requirement already satisfied: tzdata&gt;=2022.7 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pandas-&gt;moaap==0.1.0) (2025.1)
Requirement already satisfied: cftime in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from netCDF4-&gt;moaap==0.1.0) (1.6.4)
Requirement already satisfied: certifi in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from netCDF4-&gt;moaap==0.1.0) (2025.1.31)
Requirement already satisfied: networkx&gt;=3.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from scikit-image-&gt;moaap==0.1.0) (3.4.2)
Requirement already satisfied: imageio!=2.35.0,&gt;=2.33 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from scikit-image-&gt;moaap==0.1.0) (2.36.1)
Requirement already satisfied: tifffile&gt;=2022.8.12 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from scikit-image-&gt;moaap==0.1.0) (2024.12.12)
Requirement already satisfied: lazy-loader&gt;=0.4 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from scikit-image-&gt;moaap==0.1.0) (0.4)
Requirement already satisfied: platformdirs&gt;=2.1.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pint&gt;=0.17-&gt;metpy-&gt;moaap==0.1.0) (4.3.6)
Requirement already satisfied: typing_extensions&gt;=4.0.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pint&gt;=0.17-&gt;metpy-&gt;moaap==0.1.0) (4.12.2)
Requirement already satisfied: flexcache&gt;=0.3 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pint&gt;=0.17-&gt;metpy-&gt;moaap==0.1.0) (0.3)
Requirement already satisfied: flexparser&gt;=0.4 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pint&gt;=0.17-&gt;metpy-&gt;moaap==0.1.0) (0.4)
Requirement already satisfied: requests&gt;=2.19.0 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from pooch&gt;=1.2.0-&gt;metpy-&gt;moaap==0.1.0) (2.32.3)
Requirement already satisfied: six&gt;=1.5 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib-&gt;moaap==0.1.0) (1.17.0)
Requirement already satisfied: charset_normalizer&lt;4,&gt;=2 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from requests&gt;=2.19.0-&gt;pooch&gt;=1.2.0-&gt;metpy-&gt;moaap==0.1.0) (3.4.1)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from requests&gt;=2.19.0-&gt;pooch&gt;=1.2.0-&gt;metpy-&gt;moaap==0.1.0) (3.10)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /glade/u/apps/opt/conda/envs/npl-2025a/lib/python3.12/site-packages (from requests&gt;=2.19.0-&gt;pooch&gt;=1.2.0-&gt;metpy-&gt;moaap==0.1.0) (1.26.19)
Building wheels for collected packages: moaap
  Building wheel for moaap (pyproject.toml) ... done
  Created wheel for moaap: filename=moaap-0.1.0-py3-none-any.whl size=68712 sha256=fe783de058dad608f28eecb85611f1c8f0d8a4bae02c86d4351061c629fe4640
  Stored in directory: /glade/derecho/scratch/prein/tmp/pip-ephem-wheel-cache-vq7ms78_/wheels/ce/d5/fe/1aa5ed853c7827475331c1aeeeac8ddab7c8edc89fa0582f62
Successfully built moaap
Installing collected packages: moaap
Successfully installed moaap-0.1.0
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%load_ext autoreload
%autoreload 2

import numpy as np
import xarray as xr
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from IPython.display import HTML, display
import os
import warnings
import pickle
import cartopy.crs as ccrs

warnings.filterwarnings(&quot;ignore&quot;)

# --- MOAAP Imports ---
# Main Driver
from moaap import moaap

# Segmentation Tools
from moaap.utils.segmentation import (
    watershed_2d_overlap,
    watershed_3d_overlap_parallel
)
</pre></div>
</div>
</div>
<section id="Part-1:-Running-MOAAP-on-Real-Data">
<h2>Part 1: Running MOAAP on Real Data<a class="headerlink" href="#Part-1:-Running-MOAAP-on-Real-Data" title="Link to this heading"></a></h2>
<p>In this section, we load a sample dataset (24 hours of ERA5 data) and run the main <code class="docutils literal notranslate"><span class="pre">moaap</span></code> driver to identify atmospheric objects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># 1. Load Data
# Ensure you have the sample file &#39;20210701-04_MOAAP-Input_24h.nc&#39; in your directory
# If not, you might need to download it (e.g., via gdown as in the original tutorial)

try:
    data_vars = xr.open_dataset(&#39;20210701-04_MOAAP-Input_24h.nc&#39;)
    print(&quot;Data loaded successfully.&quot;)
except FileNotFoundError:
    !gdown 1hD9hD3c9rBhcTN-c5FN87l0pHp_SCscE
    data_vars = xr.open_dataset(&#39;20210701-04_MOAAP-Input_24h.nc&#39;)
    print(&quot;Data downloaded and loaded successfully.&quot;)

# 2. Setup Parameters
dT = 1 # time interval [hours]
Mask = np.ones_like(data_vars[&#39;lon&#39;].values) # Global tracking
DataName = &#39;ERA5&#39;
OutputFolder = &#39;moaap_output/&#39;

if not os.path.exists(OutputFolder):
    os.makedirs(OutputFolder)

time_datetime = pd.to_datetime(data_vars[&#39;time&#39;].values)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Downloading...
From (original): https://drive.google.com/uc?id=1hD9hD3c9rBhcTN-c5FN87l0pHp_SCscE
From (redirected): https://drive.google.com/uc?id=1hD9hD3c9rBhcTN-c5FN87l0pHp_SCscE&amp;confirm=t&amp;uuid=f2322f1d-d759-4205-863e-819aad781e13
To: /glade/u/home/prein/MajorCodeDevelopments/Feature_Tracker/MOAAP_v2.0/MOAAP/20210701-04_MOAAP-Input_24h.nc
100%|███████████████████████████████████████| 2.41G/2.41G [00:16&lt;00:00, 146MB/s]
Data downloaded and loaded successfully.
</pre></div></div>
</div>
<section id="Run-the-Tracking">
<h3>Run the Tracking<a class="headerlink" href="#Run-the-Tracking" title="Link to this heading"></a></h3>
<p>We call the <code class="docutils literal notranslate"><span class="pre">moaap</span></code> function. Note that we are only passing <code class="docutils literal notranslate"><span class="pre">pr</span></code> (Precipitation) and <code class="docutils literal notranslate"><span class="pre">tb</span></code> (Brightness Temperature) for this example to detect MCSs (Mesoscale Convective Systems). Other variables are set to <code class="docutils literal notranslate"><span class="pre">None</span></code> to speed up this tutorial.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Clean up previous run
if os.path.exists(f&quot;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&quot;):
    os.remove(f&quot;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&quot;)

# Run MOAAP
object_split = moaap(
    data_vars[&#39;lon&#39;],
    data_vars[&#39;lat&#39;],
    time_datetime,
    dT,
    Mask,
    pr=data_vars[&#39;PR&#39;].values,
    tb=data_vars[&#39;Tb&#39;].values,
    DataName=DataName,
    OutputFolder=OutputFolder,
    js_min_anomaly=12,
    MinTimeJS=12,
    # Set others to None for this tutorial
    v850=None, u850=None, t850=None, q850=None,
    slp=None, ivte=None, ivtn=None,
    z500=None, v200=None, u200=None
)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

The provided variables allow tracking the following phenomena

|  phenomenon  | tracking |
---------------------------
   Jetstream   |   no
   PSL CY/ACY  |   no
   Z500 CY/ACY |   no
   COLs        |   no
   IVT ARs     |   no
   MS ARs      |   no
   Fronts      |   no
   TCs         |   no
   MCSs        |   yes
   clouds      |   yes
   Equ. Waves  |   yes
---------------------------

======&gt; track tropical waves
        track tropical waves
            work on ER
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on MRG
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on IGW
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on Kelvin
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on Eig0
Only one chunk specified, running serial version.
                connect waves objects over date line
        00:00:09.58
======&gt; &#39;check if Tb objects qualify as MCS (or selected storm type)
        track  clouds
        break up long living cloud shield objects with watershed that have many elements
Only one chunk specified, running serial version.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
1287it [00:00, 5604.51it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            Loop over 1287 objects
            Loop over 77 objects
        00:00:02.40
======&gt; &#39;track high clouds in Tb field by excluding MCS objects
        track  clouds
        break up long living cloud shield objects with wathershedding
    Minimum distance between TB minima for watershed analysis: 40 grid cells
Only one chunk specified, running serial version.
        make sure that each object has at least one grid cell with more than min_pr threshold of precipitation
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
340it [00:00, 7684.98it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            Loop over 328 objects
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
        00:00:01.42

Save the object masks into a joint netCDF
Saved: moaap_output/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc
        00:00:05.37
</pre></div></div>
</div>
</section>
<section id="Visualize-Results">
<h3>Visualize Results<a class="headerlink" href="#Visualize-Results" title="Link to this heading"></a></h3>
<p>Let’s plot the identified MCS objects and their tracks on a map.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load the output
output_file = f&#39;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&#39;
if os.path.exists(output_file):
    data_moaap = xr.open_dataset(output_file)

    # Load MCS characteristics (tracks, size, etc.)
    pkl_file = f&#39;{OutputFolder}/MCSs_202107__dt-1h_MOAAP-masks.pkl&#39;
    if os.path.exists(pkl_file):
        with open(pkl_file, &#39;rb&#39;) as f:
            mcs_charac = pickle.load(f)

    # Plotting
    fig, ax = plt.subplots(subplot_kw={&#39;projection&#39;: ccrs.PlateCarree()}, figsize=(14, 6))
    ax.coastlines(color=&#39;#969696&#39;)
    ax.gridlines(draw_labels=True, alpha=0.5)

    # Select a specific time step (e.g., index 12)
    t_idx = 12
    if &#39;MCS_Tb_Objects&#39; in data_moaap:
        mcs_mask = data_moaap[&#39;MCS_Tb_Objects&#39;][t_idx, :, :].values.astype(float)
        mcs_mask[mcs_mask == 0] = np.nan

        sc = ax.pcolormesh(data_moaap[&#39;lon&#39;], data_moaap[&#39;lat&#39;], mcs_mask,
                           cmap=&#39;nipy_spectral&#39;, transform=ccrs.PlateCarree())
        plt.colorbar(sc, ax=ax, label=&#39;MCS Object ID&#39;)

        # Plot tracks
        if &#39;mcs_charac&#39; in locals():
            for obj_id in mcs_charac.keys():
                track = mcs_charac[obj_id][&#39;track&#39;]
                ax.plot(track[:, 1], track[:, 0], &#39;k-&#39;, linewidth=1, transform=ccrs.PlateCarree())

    ax.set_title(f&#39;MCS Objects and Tracks at {time_datetime[t_idx]}&#39;)
    plt.show()
else:
    print(&quot;MOAAP output not found. Did the tracking run successfully?&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/tutorial_8_0.png" src="_images/tutorial_8_0.png" />
</div>
</div>
</section>
<section id="Part-1.2:-Run-with-full-dataset-and-analyze">
<h3>Part 1.2: Run with full dataset and analyze<a class="headerlink" href="#Part-1.2:-Run-with-full-dataset-and-analyze" title="Link to this heading"></a></h3>
<p>In this section, we run MOAAP with the full set of atmospheric variables to identify a broader range of phenomena. We will then analyze the results, including object statistics and tracks. In the end, we will visualite some of the identified objects and generate a gif animation of their evolution over time.</p>
<p>There will be a history diagram of the MCS objects showing their life cycles with merges and splits.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Running MOAAP with full dataset (this may take a moment)...&quot;)

# Clean up previous run to ensure fresh output
if os.path.exists(f&quot;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&quot;):
    os.remove(f&quot;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&quot;)

object_split = moaap(
    data_vars[&#39;lon&#39;],
    data_vars[&#39;lat&#39;],
    time_datetime,
    dT,
    Mask,
    v850 = data_vars[&#39;V850&#39;].values,
    u850 = data_vars[&#39;U850&#39;].values,
    t850 = data_vars[&#39;T850&#39;].values,
    q850 = data_vars[&#39;Q850&#39;].values,
    slp = data_vars[&#39;SLP&#39;].values,
    ivte = data_vars[&#39;IVTE&#39;].values,
    ivtn = data_vars[&#39;IVTN&#39;].values,
    z500 = data_vars[&#39;Z500&#39;].values,
    v200 = data_vars[&#39;V200&#39;].values,
    u200 = data_vars[&#39;U200&#39;].values,
    pr   = data_vars[&#39;PR&#39;].values,
    tb   = data_vars[&#39;Tb&#39;].values,
    DataName = DataName,
    OutputFolder = OutputFolder,
    MinTimeJS = 12,
    analyze_mcs_history = True
)
print(&quot;Tracking complete.&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Running MOAAP with full dataset (this may take a moment)...

The provided variables allow tracking the following phenomena

|  phenomenon  | tracking |
---------------------------
   Jetstream   |   yes
   PSL CY/ACY  |   yes
   Z500 CY/ACY |   yes
   COLs        |   yes
   IVT ARs     |   yes
   MS ARs      |   yes
   Fronts      |   yes
   TCs         |   yes
   MCSs        |   yes
   clouds      |   yes
   Equ. Waves  |   yes
---------------------------

======&gt; track jetstream
    track jet streams
        break up long living jety objects with the watershed method
Only one chunk specified, running serial version.
            Loop over 29 objects
        00:00:02.85
======&gt; track tropical waves
        track tropical waves
            work on ER
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on MRG
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on IGW
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on Kelvin
Only one chunk specified, running serial version.
                connect waves objects over date line
            work on Eig0
Only one chunk specified, running serial version.
                connect waves objects over date line
        00:00:08.29
======&gt; track moisture streams and atmospheric rivers (ARs)
        break up long living MS objects with watershed
Only one chunk specified, running serial version.
            Loop over 13 objects
        00:00:02.36
======&gt; track IVT streams and atmospheric rivers (ARs)
        break up long living IVT objects with watershed
Only one chunk specified, running serial version.
            Loop over 12 objects
        check if MSs quallify as ARs
        00:00:00.41
            Loop over 10 objects
        00:00:02.12
======&gt; identify frontal zones
        56194 object found
        00:00:01.68
======&gt; track cyclones from PSL
        track cyclones
            31 object found
            break up long living CY objects using the watershed method
Only one chunk specified, running serial version.
        track anti-cyclones
        103 object found
            break up long living ACY objects that have many elements
Only one chunk specified, running serial version.
            Loop over 15 objects
            Loop over 74 objects
        00:00:05.98
======&gt; track cyclones from Z500
    track 500 hPa cyclones
        break up long living cyclones using the watershed method
Only one chunk specified, running serial version.
        connect cyclones objects over date line
    track 500 hPa anticyclones
        break up long living CY objects that heve many elements
Only one chunk specified, running serial version.
        connect cyclones objects over date line
            Loop over 13 objects
            Loop over 9 objects
    Check if cyclones qualify as Cut Off Low (COL)
            Loop over 12 objects
        00:00:02.60
======&gt; &#39;check if Tb objects qualify as MCS (or selected storm type)
        track  clouds
        break up long living cloud shield objects with watershed that have many elements
Only one chunk specified, running serial version.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
1287it [00:00, 4566.62it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    Minimum distance between TB minima for watershed analysis: 8 grid cells
Pre-calculating all label 2D centers at each time slice...
    Printing union array: {1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10, 11: 11, 12: 12, 13: 13, 14: 14, 15: 15, 16: 16, 17: 17, 18: 18, 19: 31, 20: 20, 21: 21, 22: 22, 23: 23, 24: 24, 25: 25, 26: 26, 27: 27, 28: 28, 29: 29, 30: 30, 31: 31, 32: 32, 33: 33, 34: 34, 35: 35, 36: 36, 37: 37, 38: 38, 39: 39, 40: 40, 41: 41, 42: 42, 43: 43, 44: 44, 45: 45, 46: 46, 47: 47, 48: 48, 49: 49, 50: 31, 51: 51, 52: 52, 53: 53, 54: 54, 55: 55, 56: 56, 57: 45, 58: 4, 59: 59, 60: 8, 61: 61, 62: 62, 63: 63, 64: 64, 65: 65, 66: 66, 67: 67, 68: 68, 69: 20, 70: 70, 71: 71, 72: 72, 73: 73, 74: 74, 75: 75, 76: 76, 77: 77}
    Printing events: [{&#39;type&#39;: &#39;merge&#39;, &#39;time&#39;: 21, &#39;from_label&#39;: 19, &#39;to_label&#39;: 50, &#39;distance&#39;: 7.7347866632283155}, {&#39;type&#39;: &#39;split&#39;, &#39;time&#39;: 5, &#39;from_label&#39;: 31, &#39;to_label&#39;: 50, &#39;distance&#39;: 7.962027789294027}, {&#39;type&#39;: &#39;split&#39;, &#39;time&#39;: 8, &#39;from_label&#39;: 45, &#39;to_label&#39;: 57, &#39;distance&#39;: 7.078138663155187}, {&#39;type&#39;: &#39;split&#39;, &#39;time&#39;: 9, &#39;from_label&#39;: 4, &#39;to_label&#39;: 58, &#39;distance&#39;: 2.914452903530629}, {&#39;type&#39;: &#39;split&#39;, &#39;time&#39;: 11, &#39;from_label&#39;: 8, &#39;to_label&#39;: 60, &#39;distance&#39;: 4.711616280342696}, {&#39;type&#39;: &#39;split&#39;, &#39;time&#39;: 10, &#39;from_label&#39;: 20, &#39;to_label&#39;: 69, &#39;distance&#39;: 5.847793961390533}]
    Printing histories: {1: [1], 2: [2], 3: [3], 4: [58, 4], 5: [5], 6: [6], 7: [7], 8: [8, 60], 9: [9], 10: [10], 11: [11], 12: [12], 13: [13], 14: [14], 15: [15], 16: [16], 17: [17], 18: [18], 31: [50, 19, 31], 20: [20, 69], 21: [21], 22: [22], 23: [23], 24: [24], 25: [25], 26: [26], 27: [27], 28: [28], 29: [29], 30: [30], 32: [32], 33: [33], 34: [34], 35: [35], 36: [36], 37: [37], 38: [38], 39: [39], 40: [40], 41: [41], 42: [42], 43: [43], 44: [44], 45: [57, 45], 46: [46], 47: [47], 48: [48], 49: [49], 51: [51], 52: [52], 53: [53], 54: [54], 55: [55], 56: [56], 59: [59], 61: [61], 62: [62], 63: [63], 64: [64], 65: [65], 66: [66], 67: [67], 68: [68], 70: [70], 71: [71], 72: [72], 73: [73], 74: [74], 75: [75], 76: [76], 77: [77]}
            Loop over 1287 objects
            Loop over 77 objects
        00:00:16.05
======&gt; &#39;track high clouds in Tb field by excluding MCS objects
        track  clouds
        break up long living cloud shield objects with wathershedding
    Minimum distance between TB minima for watershed analysis: 40 grid cells
Only one chunk specified, running serial version.
        make sure that each object has at least one grid cell with more than min_pr threshold of precipitation
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
340it [00:00, 6257.96it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            Loop over 328 objects
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
        00:00:01.41
======&gt; Check if cyclones qualify as TCs
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 15/15 [00:00&lt;00:00, 123.38it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
        00:00:00.79

Save the object masks into a joint netCDF
Saved: moaap_output/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc
        00:00:22.00
Tracking complete.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/tutorial_10_9.png" src="_images/tutorial_10_9.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Generate Frames and GIF
from tqdm import tqdm
from PIL import Image
import glob

# Reload the output to ensure we have the latest masks
output_file = f&#39;{OutputFolder}/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc&#39;
data_moaap = xr.open_dataset(output_file)

# Legend configuration
object_names = [
    [&#39;cold clouds&#39;, &#39;#737373&#39;, &#39;-&#39;, 2],
    [&#39;surface cyclones&#39;, &#39;k&#39;, &#39;-&#39;, 2],
    [&#39;mid-level cyclones&#39;, &#39;k&#39;, &#39;--&#39;, 2],
    [&#39;anticyclones&#39;, &#39;#ff7f00&#39;, &#39;-&#39;, 2],
    [&#39;MCS&#39;, &#39;#33a02c&#39;, &#39;-&#39;, 2],
    [&#39;moisture streams&#39;, &#39;r&#39;, &#39;-&#39;, 2],
    [&#39;jets&#39;, &#39;#6a3d9a&#39;, &#39;-&#39;, 2],
    [&#39;Rossby waves&#39;, &#39;#8c510a&#39;, &#39;-&#39;, 3],
    [&#39;mixed Rossby gravity waves&#39;, &#39;#bf812d&#39;, &#39;-&#39;, 1.5],
    [&#39;inertia gravity waves&#39;, &#39;#dfc27d&#39;,&#39;-&#39;, 3],
    [&#39;Kelvin waves&#39;, &#39;#abd9e9&#39;,&#39;-&#39;, 1.5],
    [&#39;eastward inertia gravity waves&#39;, &#39;#4575b4&#39;, &#39;-&#39;, 3],
    [&#39;fronts&#39;, &#39;#cab2d6&#39;, &#39;-&#39;, 2]
]

# Plotting configuration (Variable Name -&gt; Style)
# Note: We check for both generic names and specific variable names (e.g. CY_z500_Objects)
object_plotting_config = {
    &#39;MCS_Tb_Objects&#39;: {&#39;colors&#39;: &#39;#33a02c&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1},
    &#39;CY_z500_Objects&#39;: {&#39;colors&#39;: &#39;k&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1},
    &#39;COL_Objects&#39;: {&#39;colors&#39;: &#39;k&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1, &#39;linestyles&#39;: &#39;--&#39;},
    &#39;ACY_z500_Objects&#39;: {&#39;colors&#39;: &#39;#ff7f00&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1},
    &#39;JET_Objects&#39;: {&#39;colors&#39;: &#39;#6a3d9a&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1},
    &#39;AR_Objects&#39;: {&#39;colors&#39;: &#39;r&#39;, &#39;threshold&#39;: 0, &#39;linewidth&#39;: 1},
    &#39;FR_Objects&#39;: {&#39;colors&#39;: &#39;#cab2d6&#39;, &#39;threshold&#39;: 1, &#39;linewidth&#39;: 0.5},
    &#39;ER_Objects&#39;: {&#39;colors&#39;: &#39;#8c510a&#39;, &#39;threshold&#39;: 1, &#39;linewidth&#39;: 0.5}
}

# Create images directory
images_dir = &#39;images&#39;
if not os.path.exists(images_dir):
    os.makedirs(images_dir)

print(&quot;Generating frames...&quot;)
for tt in tqdm(range(len(time_datetime))):
    fig, ax = plt.subplots(subplot_kw={&#39;projection&#39;: ccrs.PlateCarree()}, figsize=(14,6))
    ax.coastlines(color=&#39;#969696&#39;)
    ax.gridlines(draw_labels=False, alpha=0.5)

    # Plot available objects
    for obj_name, config in object_plotting_config.items():
        if obj_name in data_moaap.data_vars:
            plot_args = {
                &#39;colors&#39;: config[&#39;colors&#39;],
                &#39;levels&#39;: range(0, 2, 1),
                &#39;linewidths&#39;: config.get(&#39;linewidth&#39;, 1)
            }
            if &#39;linestyles&#39; in config:
                plot_args[&#39;linestyles&#39;] = config[&#39;linestyles&#39;]

            # Handle potential NaN or 0 masking
            field = np.array(data_moaap[obj_name][tt,:,:])
            if np.any(field &gt; config[&#39;threshold&#39;]):
                ax.contour(data_moaap[&#39;lon&#39;], data_moaap[&#39;lat&#39;],
                           field &gt; config[&#39;threshold&#39;],
                           **plot_args, transform=ccrs.PlateCarree())

    ax.set_title(f&#39;Objects identified by MOAAP at {str(time_datetime[tt])[:16]}&#39;)

    # Create legend
    legend_elements = []
    for ob in range(len(object_names)):
        line, = plt.plot([], [], color=object_names[ob][1],
                 linestyle=object_names[ob][2],
                 lw=object_names[ob][3],
                 label=object_names[ob][0])
        legend_elements.append(line)

    # ax.legend(handles=legend_elements, bbox_to_anchor=(1.01, 1), loc=&#39;upper left&#39;, borderaxespad=0.)
    ax.legend(bbox_to_anchor=(1, 0.00), ncol=4)


    # Save frame
    plt.savefig(f&#39;{images_dir}/{str(tt).zfill(3)}_frame.jpg&#39;, bbox_inches=&#39;tight&#39;, dpi=100)
    plt.close(fig)

# Create GIF
print(&quot;Creating GIF...&quot;)
frames = [Image.open(image) for image in sorted(glob.glob(f&quot;{images_dir}/*_frame.jpg&quot;))]
gif_path = &quot;phenomenon.gif&quot;
if frames:
    frames[0].save(gif_path, format=&quot;GIF&quot;, append_images=frames[1:],
                   save_all=True, duration=200, loop=0)
    print(f&quot;GIF saved to {gif_path}&quot;)
else:
    print(&quot;No frames found to create GIF.&quot;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Display the GIF
from IPython.display import Image as IPImage
if os.path.exists(&quot;phenomenon.gif&quot;):
    display(IPImage(open(&quot;phenomenon.gif&quot;, &#39;rb&#39;).read()))
else:
    print(&quot;GIF not found.&quot;)
</pre></div>
</div>
</div>
</section>
</section>
<section id="Part-2:-Watershedding-Algorithm-Test">
<h2>Part 2: Watershedding Algorithm Test<a class="headerlink" href="#Part-2:-Watershedding-Algorithm-Test" title="Link to this heading"></a></h2>
<p>MOAAP relies heavily on watershedding for segmentation. Here, we test this core component using idealized synthetic data (moving “blobs”) to verify how the algorithm handles object separation and continuity in time.</p>
<p>We will compare:</p>
<ol class="arabic simple">
<li><p><strong>2D Watershedding</strong>: Applied frame-by-frame.</p></li>
<li><p><strong>3D Watershedding</strong>: Applied on the space-time cube (x, y, t).</p></li>
<li><p><strong>Parallel 3D Watershedding</strong>: Applied on the space-time cube using parallel processing for large datasets.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def generate_synthetic_moving_cells(seed: int = 42):
    &quot;&quot;&quot;
    Generates a 3D field (time, lat, lon) with synthetic moving circular &#39;storms&#39;.
    Background is 300K, storms have lower temperatures (e.g., 210K).
    &quot;&quot;&quot;
    np.random.seed(seed)
    # n_time, n_lat, n_lon = 48, 200, 200
    # n_cells = 30
    # speed = 3.0
    n_time, n_lat, n_lon = 24, 100, 100
    n_cells = 10
    speed = 2.0

    # Initialize background field
    data = np.full((n_time, n_lat, n_lon), 300.0)
    yy, xx = np.ogrid[:n_lat, :n_lon]

    boundary_val = 240.0
    center_val = 215.0

    for _ in range(n_cells):
        duration = np.random.randint(6, (n_time * 3) // 4 + 1)
        start = np.random.randint(0, n_time - duration + 1)

        max_area = np.random.uniform(200, 1500)
        max_radius = np.sqrt(max_area / np.pi)

        margin = int(np.ceil(max_radius))
        i0 = np.random.randint(margin, n_lat - margin)
        j0 = np.random.randint(margin, n_lon - margin)

        angle = np.random.uniform(0, 2 * np.pi)
        vy = speed * np.sin(angle)
        vx = speed * np.cos(angle)

        half = duration / 2
        for dt in range(duration):
            t = start + dt
            cy = i0 + vy * dt
            cx = j0 + vx * dt

            if dt &lt; half:
                r = 1 + (max_radius - 1) * (dt / half)
            else:
                r = max_radius - (max_radius - 1) * ((dt - half) / half)

            dist = np.sqrt((yy - cy)**2 + (xx - cx)**2)
            mask = dist &lt;= r

            vals = center_val + (boundary_val - center_val) * (dist / r)

            slice_t = data[t]
            slice_t[mask] = np.minimum(slice_t[mask], vals[mask])
            data[t] = slice_t

    return data

# Generate the data
synthetic_data = generate_synthetic_moving_cells(seed=43)
print(f&quot;Generated synthetic data shape: {synthetic_data.shape}&quot;)
</pre></div>
</div>
</div>
<section id="Run-Watershedding">
<h3>Run Watershedding<a class="headerlink" href="#Run-Watershedding" title="Link to this heading"></a></h3>
<p>We apply the watershedding algorithm. Note that for atmospheric data (like brightness temperature), we often invert the data (multiply by -1) because watershedding looks for the maxima, but storms are defined by low temperatures.</p>
<p>Before running the code, make sure to have min_dist at least set to 4 for the 3D cases to ensure proper object separation without numerical artifacts.</p>
<p>To run the parallel 3D code instead of the sequential version, set n_chunks_lat or n_chunks_lon to values greater than 1. The parallel code will also be called automatically if the memory overhead of the sequential code is larger than the available system memory.</p>
<p>The parallel code divides the data into spatial chunks with some overlap to ensure continuity of objects across chunk boundaries. In the end, the chunks are merged back together, leading to a little slower performance compared to the sequential version.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Parameters
tb_threshold = 241 # K
dT = 1

# 1. Run 2D Watershedding (Frame by Frame)
print(&quot;Running 2D Watershedding...&quot;)
C_objects_2d = watershed_2d_overlap(
    synthetic_data * -1,
    tb_threshold * -1,
    -235,
    5, # min distance
    dT,
    mintime=0,
    connectLon=0,
    extend_size_ratio=0.10
)

# 2. Run 3D Watershedding (Space-Time)
print(&quot;Running 3D Watershedding...&quot;)
C_objects_3d = watershed_3d_overlap_parallel(
    synthetic_data * -1,
    tb_threshold * -1,
    -235,
    5, # min distance
    dT,
    mintime=0,
    connectLon=0,
    extend_size_ratio=0.10,
    n_chunks_lat=1,
    n_chunks_lon=1
)

# 3. Run parallel 3D Watershedding (Space-Time)
print(&quot;Running parallel 3D Watershedding...&quot;)
C_objects_3d_pll = watershed_3d_overlap_parallel(
    synthetic_data * -1,
    tb_threshold * -1,
    -235,
    5, # min distance
    dT,
    mintime=0,
    connectLon=0,
    extend_size_ratio=0.10,
    n_chunks_lat=2,
    n_chunks_lon=2
)

print(f&quot;Max 2D Objects: {np.max(C_objects_2d)}&quot;)
print(f&quot;Max 3D Objects: {np.max(C_objects_3d)}&quot;)
print(f&quot;Max Parallel 3D Objects: {np.max(C_objects_3d_pll)}&quot;)
</pre></div>
</div>
</div>
</section>
<section id="Visualization-and-Comparison">
<h3>Visualization and Comparison<a class="headerlink" href="#Visualization-and-Comparison" title="Link to this heading"></a></h3>
<p>We create a side-by-side animation to compare the raw input, the 2D result, and the 3D result.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def make_comparison_animation(raw_data, objects_2d, objects_3d, objects_3d_pll):
    fig, (ax1, ax2, ax3, ax4) = plt.subplots(1, 4, figsize=(20, 5))

    # Setup colormaps
    # &#39;gist_ncar&#39; provides high contrast for object labels
    cmap_obj = plt.get_cmap(&#39;gist_ncar&#39;)
    cmap_obj.set_under(&#39;lightblue&#39;) # Set background (value 0) to light blue

    # Determine global max for consistent color scaling across 2D and 3D
    max_2d = np.max(objects_2d)
    max_3d = np.max(objects_3d)
    max_3d_pll = np.max(objects_3d_pll)

    # Initial frames
    # 1. Raw Data
    im1 = ax1.imshow(raw_data[0], cmap=&#39;viridis_r&#39;, vmin=210, vmax=300, origin=&#39;lower&#39;)
    ax1.set_title(&#39;Raw Data (Tb)&#39;)
    fig.colorbar(im1, ax=ax1, fraction=0.046, pad=0.04, label=&#39;Temperature [K]&#39;)

    # 2. 2D Objects
    # We pass the raw array (with 0s). vmin=1 ensures 0 is treated as &quot;under&quot; (background)
    im2 = ax2.imshow(objects_2d[0], cmap=cmap_obj, vmin=1, vmax=max_2d, origin=&#39;lower&#39;)
    ax2.set_title(&#39;2D Watershed&#39;)
    fig.colorbar(im2, ax=ax2, fraction=0.046, pad=0.04, label=&#39;Object ID&#39;)

    # 3. 3D Objects
    im3 = ax3.imshow(objects_3d[0], cmap=cmap_obj, vmin=1, vmax=max_3d, origin=&#39;lower&#39;)
    ax3.set_title(&#39;3D Watershed&#39;)
    fig.colorbar(im3, ax=ax3, fraction=0.046, pad=0.04, label=&#39;Object ID&#39;)

    # 4. parallel 3D Objects
    im4 = ax4.imshow(objects_3d_pll[0], cmap=cmap_obj, vmin=1, vmax=max_3d_pll, origin=&#39;lower&#39;)
    ax4.set_title(&#39;Parallel 3D Watershed&#39;)
    fig.colorbar(im4, ax=ax4, fraction=0.046, pad=0.04, label=&#39;Object ID&#39;)

    title = fig.suptitle(&#39;Time step: 0&#39;)

    fig.tight_layout(rect=[0, 0.03, 1, 0.95])

    def update(frame):
        im1.set_data(raw_data[frame])
        im2.set_data(objects_2d[frame])
        im3.set_data(objects_3d[frame])
        im4.set_data(objects_3d_pll[frame])

        title.set_text(f&#39;Time step: {frame}&#39;)
        return [im1, im2, im3, title]

    anim = animation.FuncAnimation(fig, update, frames=len(raw_data), interval=200, blit=False)
    plt.close(fig)
    return HTML(anim.to_jshtml())

# Generate and display the animation
animation_html = make_comparison_animation(synthetic_data, C_objects_2d, C_objects_3d, C_objects_3d_pll)
display(animation_html)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-left" title="MOAAP Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Andreas F. Prein, Raphael Graf.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>