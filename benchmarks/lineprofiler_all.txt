 
The provided variables allow tracking the following phenomena
 
|  phenomenon  | tracking |
---------------------------
   Jetstream   |   yes
   PSL CY/ACY  |   yes
   Z500 CY/ACY |   yes
   COLs        |   yes
   IVT ARs     |   yes
   MS ARs      |   yes
   Fronts      |   yes
   TCs         |   yes
   MCSs        |   yes
   clouds      |   yes
   Equ. Waves  |   no
---------------------------
 
======> track jetstream
            25 object found
        break up long living jety objects with the watershed method
            Loop over 50 objects
        00:00:32.08
======> track moisture streams and atmospheric rivers (ARs)
            650 object found
        break up long living MS objects with watershed
            Loop over 13 objects
        00:00:06.07
======> track IVT streams and atmospheric rivers (ARs)
        149 object found
        break up long living IVT objects with watershed
            Loop over 11 objects
        check if MSs quallify as ARs
        00:00:00.57
            Loop over 4 objects
        00:00:03.89
======> identify frontal zones
        56194 object found
        00:00:06.10
======> track cyclones from PSL
        track cyclones
            70 object found
            break up long living CY objects using the watershed method
        track anti-cyclones
        103 object found
            break up long living ACY objects that have many elements
            Loop over 34 objects
            Loop over 74 objects
        00:00:14.56
======> track cyclones from Z500
    track 500 hPa cyclones
            35 object found
        break up long living cyclones using the watershed method
        connect cyclones objects over date line
    track 500 hPa anticyclones
            22 object found
        break up long living CY objects that heve many elements
        connect cyclones objects over date line
            Loop over 42 objects
            Loop over 38 objects
    Check if cyclones qualify as Cut Off Low (COL)
            Loop over 40 objects
        00:00:12.19
======> 'check if Tb objects qualify as MCS (or selected storm type)
        track  clouds
        8339 cloud object found
        fast way that removes obviously too small objects
        92 cloud object remaining
        break up long living cloud shield objects with watershed that have many elements
            Loop over 4280 objects
            Loop over 100 objects
        00:00:09.78
======> 'track high clouds in Tb field by excluding MCS objects
        track  clouds
        break up long living cloud shield objects with wathershedding
        make sure that each object has at least one grid cell with more than min_pr threshold of precipitation
            Loop over 878 objects
        00:00:04.08
======> Check if cyclones qualify as TCs
        00:00:01.07
 
Save the object masks into a joint netCDF
Saved: moaap_output/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc
        00:00:29.18
Wrote profile results to '2d_vs_3d.py.lprof'
Timer unit: 1e-06 s

Total time: 1.94358 s
File: /home/raphael/Documents/Studium/9.Semester/Semester_thesis/Semester-thesis/Tracking_Functions.py
Function: clean_up_objects at line 2158

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  2158                                           @profile
  2159                                           def clean_up_objects(DATA,
  2160                                                                dT,
  2161                                                                min_tsteps = 0,
  2162                                                                obj_splitmerge = None):
  2163                                               """ Function to remove objects that are too short lived
  2164                                                   and to numerrate the object from 1...N
  2165                                               """
  2166                                               
  2167         9     884145.0  98238.3     45.5      object_indices = ndimage.find_objects(DATA)
  2168         9      78272.6   8697.0      4.0      MaxOb = np.max(DATA)
  2169         9         58.6      6.5      0.0      MinLif = int(24 / dT)  # min lifetime of object to be split
  2170         9         14.7      1.6      0.0      AVmax = 1.5
  2171                                           
  2172         9         99.1     11.0      0.0      id_translate = np.zeros((len(object_indices),2))
  2173         9     275344.3  30593.8     14.2      objectsTMP = np.zeros_like(DATA)
  2174         9         25.9      2.9      0.0      ii = 1
  2175      5027       3596.7      0.7      0.2      for obj in range(len(object_indices)):
  2176      5018       3788.5      0.8      0.2          if object_indices[obj] != None:
  2177      1299       1430.0      1.1      0.1              if object_indices[obj][0].stop - object_indices[obj][0].start >= min_tsteps / dT:
  2178       305     349326.9   1145.3     18.0                  Obj_tmp = np.copy(objectsTMP[object_indices[obj]])
  2179       305     237123.0    777.5     12.2                  Obj_tmp[DATA[object_indices[obj]] == obj+1] = ii
  2180       305     100634.8    330.0      5.2                  objectsTMP[object_indices[obj]] = Obj_tmp
  2181       305        582.8      1.9      0.0                  id_translate[obj,0] = obj+1
  2182       305        319.4      1.0      0.0                  id_translate[obj,1] = ii
  2183       305        274.4      0.9      0.0                  ii = ii + 1
  2184                                                       else:
  2185       994        898.5      0.9      0.0                  id_translate[obj,0] = obj+1
  2186       994        817.2      0.8      0.0                  id_translate[obj,1] = -1
  2187                                                   else:
  2188      3719       3441.3      0.9      0.2              id_translate[obj,0] = obj+1
  2189      3719       3321.4      0.9      0.2              id_translate[obj,1] = -1
  2190                                           
  2191                                               # adjust the directory strucutre accordingly
  2192         9         13.5      1.5      0.0      obj_splitmerge_clean = {}
  2193                                           
  2194         9         13.8      1.5      0.0      if obj_splitmerge != None:
  2195                                                   id_translate = id_translate.astype(int)  
  2196                                                   keys = np.copy(list(obj_splitmerge.keys()))
  2197                                                   for jj in range(len(keys)):
  2198                                                       obj_loc = np.where(int(list(keys)[jj]) == id_translate[:,0])[0][0]
  2199                                                       if id_translate[obj_loc,1] == -1:
  2200                                                           del obj_splitmerge[list(keys)[jj]]
  2201                                           
  2202                                                   # loop over objects and relable their indices if nescessary
  2203                                                   obj_splitmerge_clean = {}
  2204                                                   keys = np.copy(list(obj_splitmerge.keys()))
  2205                                                   core_translate = np.isin(id_translate[:,0], keys.astype(int))
  2206                                                   id_translate = id_translate[core_translate,:]
  2207                                                   for jj in range(len(keys)):
  2208                                                       obj_loc = np.where(int(list(keys)[jj]) == id_translate[:,0])[0][0]
  2209                                                       mergsplit = np.array(obj_splitmerge[keys[jj]])
  2210                                                       for kk in range(id_translate.shape[0]):
  2211                                                           mergsplit[np.isin(mergsplit, id_translate[kk,0])] = id_translate[kk,1]
  2212                                                       obj_splitmerge_clean[str(int(id_translate[obj_loc,1]))] = mergsplit
  2213                                                   
  2214         9         39.3      4.4      0.0      return objectsTMP, obj_splitmerge_clean

Total time: 28.2527 s
File: /home/raphael/Documents/Studium/9.Semester/Semester_thesis/Semester-thesis/Tracking_Functions.py
Function: watershed_2d_overlap at line 4091

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  4091                                           @profile
  4092                                           # This function performs watershedding on 2D anomaly fields and
  4093                                           # succeeds an older version of this function (watershed_2d_overlap_temp_discontin).
  4094                                           # This function uses spatially reduced watersheds from the previous time step as seed for the
  4095                                           # current time step, which improves temporal consistency of features.
  4096                                           def watershed_2d_overlap(data, # 3D matrix with data for watershedding [np.array]
  4097                                                                    object_threshold, # float to create binary object mast [float]
  4098                                                                    max_treshold, # value for identifying max. points for spreading [float]
  4099                                                                    min_dist, # minimum distance (in grid cells) between maximum points [int]
  4100                                                                    dT, # time interval in hours [int]
  4101                                                                    mintime = 24, # minimum time an object has to exist in dT [int]
  4102                                                                    connectLon = 0,  # do we have to track features over the date line?
  4103                                                                    extend_size_ratio = 0.25, # if connectLon = 1 this key is setting the ratio of the zonal domain added to the watershedding. This has to be big for large objects (e.g., ARs) and can be smaller for e.g., MCSs
  4104                                                                    erosion_disk = 3.5): 
  4105                                           
  4106         1         14.8     14.8      0.0      from scipy import ndimage as ndi
  4107         1         61.7     61.7      0.0      from skimage.feature import peak_local_max
  4108         1          6.0      6.0      0.0      from skimage.segmentation import watershed
  4109         1          6.1      6.1      0.0      from scipy.ndimage import gaussian_filter
  4110         1          2.6      2.6      0.0      from Tracking_Functions import clean_up_objects
  4111         1          1.5      1.5      0.0      from Tracking_Functions import ConnectLon_on_timestep
  4112                                               
  4113         1          0.6      0.6      0.0      if connectLon == 1:
  4114         1          0.8      0.8      0.0          axis = 1
  4115         1          2.5      2.5      0.0          extension_size = int(data.shape[1] * extend_size_ratio)
  4116         2      62009.9  31004.9      0.2          data = np.concatenate(
  4117         1          3.4      3.4      0.0                  [data[:, :, -extension_size:], data, data[:, :, :extension_size]], axis=2
  4118                                                       )
  4119         1      64498.0  64498.0      0.2      data_2d_watershed = np.copy(data); data_2d_watershed[:] = np.nan
  4120        25      20471.2    818.8      0.1      for tt in tqdm(range(data.shape[0])):
  4121        24      19728.4    822.0      0.1          image = data[tt,:] >= object_threshold
  4122        24         90.3      3.8      0.0          data_t0 = data[tt,:,:]
  4123                                           
  4124                                                   # get maximum precipitation over three time steps to make fields more coherant
  4125        48     822272.2  17130.7      2.9          coords = peak_local_max(data_t0, 
  4126        24         21.5      0.9      0.0                                  min_distance = min_dist,
  4127        24         33.0      1.4      0.0                                  threshold_abs = max_treshold,
  4128        24         14.4      0.6      0.0                                  labels = image
  4129                                                                          )
  4130                                               
  4131        24       1310.2     54.6      0.0          mask = np.zeros(data_t0.shape, dtype=bool)
  4132        24        343.9     14.3      0.0          mask[tuple(coords.T)] = True
  4133        24     125057.5   5210.7      0.4          markers, _ = ndi.label(mask)
  4134                                               
  4135        24         73.2      3.0      0.0          if tt != 0:
  4136                                                       # allow markers to change a bit from time to time and 
  4137                                                       # introduce new markers if they have strong enough max/min and
  4138                                                       # are far enough away from existing objects
  4139        23        500.8     21.8      0.0              from skimage.segmentation import find_boundaries
  4140        23        359.0     15.6      0.0              from skimage.morphology import erosion, square, disk, rectangle
  4141        23    1581181.3  68747.0      5.6              boundaries = find_boundaries(data_2d_watershed[tt-1,:,:].astype("int"), mode='outer')
  4142                                                       # Set boundaries to zero in the markers
  4143        23      58866.1   2559.4      0.2              separated_markers = np.copy(data_2d_watershed[tt-1,:,:].astype("int"))
  4144        23      33485.4   1455.9      0.1              separated_markers[boundaries] = 0
  4145        23        523.0     22.7      0.0              from skimage.morphology import erosion
  4146        23    1523400.4  66234.8      5.4              separated_markers = erosion(separated_markers, disk(erosion_disk)) #3.5
  4147        23      26304.1   1143.7      0.1              separated_markers[data_2d_watershed[tt,:,:] == 0] = 0
  4148                                                       
  4149                                                       # add unique new markers if they are not too close to old objects
  4150        23        777.4     33.8      0.0              from skimage.morphology import dilation, square, disk
  4151        23     796429.9  34627.4      2.8              dilated_matrix = dilation(data_2d_watershed[tt-1,:,:].astype("int"), disk(2.5))
  4152        23     106809.9   4643.9      0.4              markers_updated = (markers + np.max(separated_markers)).astype("int")
  4153        23      82451.5   3584.8      0.3              markers_updated[markers_updated == np.max(separated_markers)] = 0
  4154        23      48533.2   2110.1      0.2              markers_add = (markers_updated != 0) & (dilated_matrix == 0)
  4155                                                       
  4156        23       5685.9    247.2      0.0              separated_markers[markers_add] = markers_updated[markers_add]
  4157        23         54.5      2.4      0.0              markers = separated_markers
  4158                                                       # break up elements that are no longer connected
  4159        23     181334.6   7884.1      0.6              markers, _ = ndi.label(markers)
  4160                                               
  4161                                                       # make sure that spatially separate objects have unique labels
  4162                                                       # markers, _ = ndi.label(mask)
  4163        48   17498335.7 364548.7     61.9          data_2d_watershed[tt,:,:] = watershed(image = np.array(data[tt,:])*-1,  # watershedding field with maxima transformed to minima
  4164        24         64.8      2.7      0.0                          markers = markers, # maximum points in 3D matrix
  4165        24        849.8     35.4      0.0                          connectivity = np.ones((3, 3)), # connectivity
  4166        24        498.5     20.8      0.0                          offset = (np.ones((2)) * 1).astype('int'), #4000/dx_m[dx]).astype('int'),
  4167        24         36.3      1.5      0.0                          mask = image, # binary mask for areas to watershed on
  4168        24         27.1      1.1      0.0                          compactness = 0) # high values --> more regular shaped watersheds
  4169                                               
  4170         1          1.6      1.6      0.0      if connectLon == 1:
  4171                                                   # Crop to the original size
  4172                                                   # start = extension_size
  4173                                                   # end = start + image.shape[axis]
  4174         1          1.0      1.0      0.0          if extension_size != 0:
  4175         1      74352.0  74352.0      0.3              data_2d_watershed = np.array(data_2d_watershed[:, :, extension_size:-extension_size])
  4176         1     532585.5 532585.5      1.9          data_2d_watershed = ConnectLon_on_timestep(data_2d_watershed.astype("int"))
  4177                                           
  4178                                               ### CONNECT OBJECTS IN 3D BASED ON MAX OVERLAP
  4179         1     193341.3 193341.3      0.7      labels = np.array(data_2d_watershed).astype('int')
  4180         2    4389870.5 2.19e+06     15.5      objects = connect_3d_objects(labels, 
  4181         1          5.4      5.4      0.0                                   int(mintime/dT), 
  4182         1          0.6      0.6      0.0                                   dT)
  4183         1          4.1      4.1      0.0      return objects

Total time: 1.10687 s
File: /home/raphael/Documents/Studium/9.Semester/Semester_thesis/Semester-thesis/Tracking_Functions.py
Function: label_peaks_over_time_3d at line 4187

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  4187                                           @profile
  4188                                           def label_peaks_over_time_3d(coords, max_dist=5):
  4189                                               """
  4190                                               coords: np.ndarray of shape (N_peaks, 3), each row is [t, y, x]
  4191                                               max_dist: maximum allowed distance to consider peaks as the same object (in grid units)
  4192                                               Returns: labels, np.ndarray of shape (N_peaks,), integer labels for each peak
  4193                                               """
  4194                                               # Split coords by timestep
  4195         8        724.0     90.5      0.1      timesteps = np.unique(coords[:, 0])
  4196         8         42.7      5.3      0.0      labels = np.zeros(coords.shape[0], dtype=int)
  4197         8          8.1      1.0      0.0      next_label = 1
  4198         8          7.4      0.9      0.0      prev_coords = None
  4199         8          7.2      0.9      0.0      prev_labels = None
  4200                                           
  4201       200        240.6      1.2      0.0      for t in timesteps:
  4202       192       3087.4     16.1      0.3          idx_t = np.where(coords[:, 0] == t)[0]
  4203       192       1547.7      8.1      0.1          coords_t = coords[idx_t][:, 1:3]  # [y, x] only
  4204       192        423.2      2.2      0.0          labels_t = np.zeros(coords_t.shape[0], dtype=int)
  4205       192        184.4      1.0      0.0          if prev_coords is None or prev_coords.shape[0] == 0:
  4206                                                       # First timestep: assign new labels
  4207         8         66.2      8.3      0.0              labels_t[:] = np.arange(next_label, next_label + coords_t.shape[0])
  4208         8         12.3      1.5      0.0              next_label += coords_t.shape[0]
  4209                                                   else:
  4210                                                       # Build KDTree for previous peaks
  4211       184      13795.0     75.0      1.2              tree = cKDTree(prev_coords)
  4212     19530      17530.9      0.9      1.6              for i, peak in enumerate(coords_t):
  4213     19346    1028347.4     53.2     92.9                  dist, idx = tree.query(peak, distance_upper_bound=max_dist)
  4214     19346      17248.7      0.9      1.6                  if dist < max_dist and idx < prev_coords.shape[0]:
  4215     14835      15569.1      1.0      1.4                      labels_t[i] = prev_labels[idx]
  4216                                                           else:
  4217      4511       3689.6      0.8      0.3                      labels_t[i] = next_label
  4218      4511       2955.6      0.7      0.3                      next_label += 1
  4219       192        352.7      1.8      0.0          labels[idx_t] = labels_t
  4220       192        180.9      0.9      0.0          prev_coords = coords_t
  4221       192        832.3      4.3      0.1          prev_labels = labels_t
  4222         8         17.8      2.2      0.0      return labels

Total time: 30.0608 s
File: /home/raphael/Documents/Studium/9.Semester/Semester_thesis/Semester-thesis/Tracking_Functions.py
Function: watershed_3d_overlap at line 4266

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  4266                                           @profile
  4267                                           def watershed_3d_overlap(data, # 3D matrix with data for watershedding [np.array]
  4268                                                                    object_threshold, # float to create binary object mast [float]
  4269                                                                    max_treshold, # value for identifying max. points for spreading [float]
  4270                                                                    min_dist, # minimum distance (in grid cells) between maximum points [int]
  4271                                                                    dT, # time interval in hours [int]
  4272                                                                    mintime = 24, # minimum time an object has to exist in dT [int]
  4273                                                                    connectLon = 0,  # do we have to track features over the date line?
  4274                                                                    extend_size_ratio = 0.25, _timer=None): # if connectLon = 1 this key is setting the ratio of the zonal domain added to the watershedding. This has to be big for large objects (e.g., ARs) and can be smaller for e.g., MCSs
  4275                                               
  4276                                               # from Tracking_Functions import ConnectLon_on_timestep
  4277                                               # with _timer("setup"):
  4278                                                   # Determine if we need to extend the data for date line crossing
  4279         8         32.7      4.1      0.0      if connectLon == 1:
  4280         6         11.6      1.9      0.0          axis = 2
  4281         6         30.8      5.1      0.0          extension_size = int(data.shape[2] * extend_size_ratio)
  4282        12     411751.7  34312.6      1.4          data = np.concatenate(
  4283         6         40.8      6.8      0.0                  [data[:, :, -extension_size:], data, data[:, :, :extension_size]], axis=axis
  4284                                                       )
  4285                                               
  4286                                               # Create binary mask for watershedding, all data that needs to be segmented is True
  4287         8     164459.4  20557.4      0.5      image = data >= object_threshold
  4288                                               
  4289                                               # with _timer("find peaks"):
  4290         8         24.3      3.0      0.0      coords_list = []
  4291                                           
  4292                                               # find peaks in each time slice and add time as an additional coordinate
  4293       200        279.5      1.4      0.0      for t in range(data.shape[0]):
  4294       384    5968936.7  15544.1     19.9          coords_t = peak_local_max(data[t], 
  4295       192        178.9      0.9      0.0                                  min_distance = min_dist,
  4296       192        115.2      0.6      0.0                                  threshold_abs = max_treshold,
  4297       192        241.7      1.3      0.0                                  labels = image[t],
  4298       192        119.4      0.6      0.0                                  exclude_border=True
  4299                                                                       )
  4300                                           
  4301       192       9131.6     47.6      0.0          coords_with_time = np.column_stack((np.full(coords_t.shape[0], t), coords_t))
  4302       192        217.7      1.1      0.0          coords_list.append(coords_with_time)
  4303                                           
  4304                                               # Combine all coordinates into a single array
  4305         8          7.2      0.9      0.0      if len(coords_list) > 0:
  4306         8        740.9     92.6      0.0          coords = np.vstack(coords_list)
  4307                                               else:
  4308                                                   coords = np.empty((0, 3), dtype=int)
  4309                                           
  4310                                               # with _timer("label peaks over time"):
  4311         8       3216.2    402.0      0.0      mask = np.zeros(data.shape, dtype=bool)
  4312         8      28202.4   3525.3      0.1      mask[tuple(coords.T)] = True
  4313                                           
  4314                                               # label peaks over time to ensure temporal consistency
  4315         8    1132307.0 141538.4      3.8      labels = label_peaks_over_time_3d(coords, max_dist=min_dist)
  4316         8        259.2     32.4      0.0      markers = np.zeros(data.shape, dtype=np.int16)
  4317         8      72363.0   9045.4      0.2      markers[tuple(coords.T)] = labels
  4318                                               
  4319                                               # with _timer("watershed"):
  4320                                                   # define connectivity for 3D watershedding and perform watershedding
  4321         8        395.5     49.4      0.0      conection = np.ones((3, 3, 3))
  4322        16   21326811.6 1.33e+06     70.9      watershed_results = watershed(image = np.array(data)*-1,  # watershedding field with maxima transformed to minima
  4323         8         26.3      3.3      0.0                      markers = markers, # maximum points in 3D matrix
  4324         8          7.7      1.0      0.0                      connectivity = conection, # connectivity
  4325         8        487.1     60.9      0.0                      offset = (np.ones((3)) * 1).astype('int'), #4000/dx_m[dx]).astype('int'),
  4326         8         10.2      1.3      0.0                      mask = image, # binary mask for areas to watershed on
  4327         8          7.8      1.0      0.0                      compactness = 0) # high values --> more regular shaped watersheds
  4328                                           
  4329                                               # correct objects on date line if needed
  4330         8         25.1      3.1      0.0      if connectLon == 1:
  4331         6          7.2      1.2      0.0          if extension_size != 0:
  4332         6      58736.2   9789.4      0.2              watershed_results = np.array(watershed_results[:, :, extension_size:-extension_size])
  4333         6     881578.8 146929.8      2.9          watershed_results = ConnectLon_on_timestep(watershed_results.astype("int"))
  4334                                           
  4335         8         33.1      4.1      0.0      return watershed_results

Total time: 119.236 s
File: /home/raphael/Documents/Studium/9.Semester/Semester_thesis/Semester-thesis/Tracking_Functions.py
Function: moaap at line 4782

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  4782                                           @profile
  4783                                           def moaap(
  4784                                               Lon,                           # 2D longitude grid centers
  4785                                               Lat,                           # 2D latitude grid spacing
  4786                                               Time,                          # datetime vector of data
  4787                                               dT,                            # integer - temporal frequency of data [hour]
  4788                                               Mask,                          # mask with dimensions [lat,lon] defining analysis region
  4789                                               *, 
  4790                                               config_file=None, 
  4791                                               **kw):
  4792                                               
  4793                                               """
  4794                                               Parameters
  4795                                               ----------
  4796                                               Lon : array_like
  4797                                                   2D array of longitude grid centers.
  4798                                               Lat : array_like
  4799                                                   2D array of latitude grid centers.
  4800                                               Time : array_like of datetime
  4801                                                   1D vector of datetimes for each time step.
  4802                                               dT : int
  4803                                                   Temporal frequency of the data in hours.
  4804                                               Mask : array_like
  4805                                                   2D mask defining the analysis region.
  4806                                           
  4807                                               Keyword Arguments
  4808                                               -----------------
  4809                                               v850 : array_like or None, default=None
  4810                                                   850 hPa zonal wind speed (m/s).
  4811                                               u850 : array_like or None, default=None
  4812                                                   850 hPa meridional wind speed (m/s).
  4813                                               t850 : array_like or None, default=None
  4814                                                   850 hPa air temperature (K).
  4815                                               q850 : array_like or None, default=None
  4816                                                   850 hPa mixing ratio (g/kg).
  4817                                               slp : array_like or None, default=None
  4818                                                   Sea level pressure (Pa).
  4819                                               ivte : array_like or None, default=None
  4820                                                   Zonal integrated vapor transport (kg m⁻¹ s⁻¹).
  4821                                               ivtn : array_like or None, default=None
  4822                                                   Meridional integrated vapor transport (kg m⁻¹ s⁻¹).
  4823                                               z500 : array_like or None, default=None
  4824                                                   Geopotential height at 500 hPa (gpm).
  4825                                               v200 : array_like or None, default=None
  4826                                                   200 hPa zonal wind speed (m/s).
  4827                                               u200 : array_like or None, default=None
  4828                                                   200 hPa meridional wind speed (m/s).
  4829                                               pr : array_like or None, default=None
  4830                                                   Accumulated surface precipitation (mm per time step).
  4831                                               tb : array_like or None, default=None
  4832                                                   Brightness temperature (K).
  4833                                               DataName : str, default=''
  4834                                                   Name of the common grid.
  4835                                               OutputFolder : str, default=''
  4836                                                   Path to the output directory.
  4837                                           
  4838                                               # — Precipitation objects —
  4839                                               SmoothSigmaP : float, default=0
  4840                                                   Gaussian σ for precipitation smoothing.
  4841                                               Pthreshold : float, default=2
  4842                                                   Precipitation threshold (mm h⁻¹).
  4843                                               MinTimePR : int, default=4
  4844                                                   Minimum lifetime of precipitation features (h).
  4845                                               MinAreaPR : float, default=5000
  4846                                                   Minimum area of precipitation features (km²).
  4847                                           
  4848                                               # — Moisture streams —
  4849                                               MinTimeMS : int, default=9
  4850                                                   Minimum lifetime of moisture stream features (h).
  4851                                               MinAreaMS : float, default=100000
  4852                                                   Minimum area of moisture stream features (km²).
  4853                                               MinMSthreshold : float, default=0.11
  4854                                                   Detection threshold for moisture streams (g·m/g·s).
  4855                                           
  4856                                               # — Cyclones & anticyclones —
  4857                                               MinTimeCY : int, default=12
  4858                                                   Minimum lifetime of cyclones (h).
  4859                                               MaxPresAnCY : float, default=-8
  4860                                                   Pressure anomaly threshold for cyclones (hPa).
  4861                                               breakup_cy : str, default='watershed'
  4862                                                   Method for cyclone breakup.
  4863                                               MinTimeACY : int, default=12
  4864                                                   Minimum lifetime of anticyclones (h).
  4865                                               MinPresAnACY : float, default=6
  4866                                                   Pressure anomaly threshold for anticyclones (hPa).
  4867                                           
  4868                                               # — Frontal zones —
  4869                                               MinAreaFR : float, default=50000
  4870                                                   Minimum area of frontal zones (km²).
  4871                                               front_treshold : float, default=1
  4872                                                   Threshold for masking frontal zones.
  4873                                           
  4874                                               # — Cloud tracking —
  4875                                               SmoothSigmaC : float, default=0
  4876                                                   Gaussian σ for cloud‐shield smoothing.
  4877                                               Cthreshold : float, default=241
  4878                                                   Brightness temperature threshold for ice‐cloud shields (K).
  4879                                               MinTimeC : int, default=4
  4880                                                   Minimum lifetime of ice‐cloud shields (h).
  4881                                               MinAreaC : float, default=40000
  4882                                                   Minimum area of ice‐cloud shields (km²).
  4883                                           
  4884                                               # — Atmospheric rivers (AR) —
  4885                                               IVTtrheshold : float, default=500
  4886                                                   Integrated vapor transport threshold for AR detection (kg m⁻¹ s⁻¹).
  4887                                               MinTimeIVT : int, default=12
  4888                                                   Minimum lifetime of ARs (h).
  4889                                               breakup_ivt : str, default='watershed'
  4890                                                   Method for AR breakup.
  4891                                               AR_MinLen : float, default=2000
  4892                                                   Minimum length of an AR (km).
  4893                                               AR_Lat : float, default=20
  4894                                                   Minimum centroid latitude for ARs (degrees N).
  4895                                               AR_width_lenght_ratio : float, default=2
  4896                                                   Minimum length‐to‐width ratio for ARs.
  4897                                           
  4898                                               # — Tropical cyclone detection —
  4899                                               TC_Pmin : float, default=995
  4900                                                   Minimum central pressure for TC detection (hPa).
  4901                                               TC_lat_genesis : float, default=35
  4902                                                   Maximum latitude for TC genesis (degrees).
  4903                                               TC_lat_max : float, default=60
  4904                                                   Maximum latitude for TC existence (degrees).
  4905                                               TC_deltaT_core : float, default=0
  4906                                                   Minimum core‐to‐environment temperature difference (K).
  4907                                               TC_T850min : float, default=285
  4908                                                   Minimum core temperature at 850 hPa for TCs (K).
  4909                                           
  4910                                               # — Mesoscale convective systems (MCS) —
  4911                                               MCS_Minsize : float, default=5000
  4912                                                   Minimum precipitation area size for MCS (km²).
  4913                                               MCS_minPR : float, default=15
  4914                                                   Precipitation threshold for MCS detection (mm h⁻¹).
  4915                                               CL_MaxT : float, default=215
  4916                                                   Maximum brightness temperature in ice shield for MCS (K).
  4917                                               CL_Area : float, default=40000
  4918                                                   Minimum cloud area for MCS detection (km²).
  4919                                               MCS_minTime : int, default=4
  4920                                                   Minimum lifetime of MCS (h).
  4921                                           
  4922                                               # — Jet streams & tropical waves —
  4923                                               js_min_anomaly : float, default=37
  4924                                                   Minimum jet‐stream anomaly (m/s).
  4925                                               MinTimeJS : int, default=24
  4926                                                   Minimum lifetime of jet streams (h).
  4927                                               breakup_jet : str, default='watershed'
  4928                                                   Method for jet‐stream breakup.
  4929                                               tropwave_minTime : int, default=48
  4930                                                   Minimum lifetime of tropical waves (h).
  4931                                               breakup_mcs : str, default='watershed'
  4932                                                   Method for MCS breakup.
  4933                                           
  4934                                               # — 500 hPa cyclones/anticyclones —
  4935                                               z500_low_anom : float, default=-80
  4936                                                   Minimum anomaly for 500 hPa cyclones (m).
  4937                                               z500_high_anom : float, default=70
  4938                                                   Minimum anomaly for 500 hPa anticyclones (m).
  4939                                               breakup_zcy : str, default='watershed'
  4940                                                   Method for 500 hPa cyclone/anticyclone breakup.
  4941                                           
  4942                                               # — Equatorial waves —
  4943                                               er_th : float, default=0.05
  4944                                                   Threshold for equatorial Rossby waves.
  4945                                               mrg_th : float, default=0.05
  4946                                                   Threshold for mixed Rossby‐gravity waves.
  4947                                               igw_th : float, default=0.20
  4948                                                   Threshold for inertia–gravity waves.
  4949                                               kel_th : float, default=0.10
  4950                                                   Threshold for Kelvin waves.
  4951                                               eig0_th : float, default=0.10
  4952                                                   Threshold for n≥1 inertia–gravity waves.
  4953                                               breakup_tw : str, default='watershed'
  4954                                                   Method for equatorial wave breakup.
  4955                                           
  4956                                               Returns
  4957                                               -------
  4958                                               dict
  4959                                                   A dictionary containing detected features grouped by type
  4960                                                   (e.g., 'precip', 'moisture', 'cyclones', etc.).
  4961                                               """
  4962                                               
  4963         1          8.4      8.4      0.0      params = MOAAP_DEFAULTS.copy()
  4964                                               # ... load/merge config_file if given ...
  4965         1          5.3      5.3      0.0      params.update(kw)
  4966                                               # check if the input variables are np.arrays
  4967         1          2.7      2.7      0.0      required_keys = [
  4968                                                   "v850",  "u850",  "t850",  "q850",  "slp",
  4969                                                   "ivte",  "ivtn",  "z500",  "v200",  "u200",
  4970                                                   "pr",    "tb"
  4971                                               ]
  4972                                           
  4973        13         19.0      1.5      0.0      for key in required_keys:
  4974        12         16.1      1.3      0.0          if key in params:
  4975        12         21.7      1.8      0.0              if type(params[key]) is not type(None):
  4976        12         21.9      1.8      0.0                  if not isinstance(params[key], np.ndarray):
  4977                                                               # Display which variable is wrong, then stop
  4978                                                               raise TypeError(f"Parameter '{key}' must be a numpy.ndarray, got {type(params[key]).__name__}")
  4979                                           
  4980         1          2.6      2.6      0.0      v850 = params["v850"]                   # 850 hPa zonal wind speed [m/s]
  4981         1          2.3      2.3      0.0      u850 = params["u850"]                   # 850 hPa meridional wind speed [m/s]
  4982         1          2.2      2.2      0.0      t850 = params["t850"]                   # 850 hPa air temperature [K]
  4983         1          2.7      2.7      0.0      q850 = params["q850"]                   # 850 hPa mixing ratio [g/kg]
  4984         1          2.4      2.4      0.0      slp =  params["slp"]                    # sea level pressure [Pa]
  4985         1          2.7      2.7      0.0      ivte = params["ivte"]                   # zonal integrated vapor transport [kg m-1 s-1]
  4986         1          2.8      2.8      0.0      ivtn = params["ivtn"]                   # meridional integrated vapor transport [kg m-1 s-1]
  4987         1          2.4      2.4      0.0      z500 = params["z500"]                   # geopotential height [gpm]
  4988         1          2.4      2.4      0.0      v200 = params["v200"]                   # 200 hPa zonal wind speed [m/s]
  4989         1          2.4      2.4      0.0      u200 = params["u200"]                   # 200 hPa meridional wind speed [m/s]
  4990         1          2.5      2.5      0.0      pr   = params["pr"]                     # accumulated surface precipitation [mm/time]
  4991         1          2.6      2.6      0.0      tb   = params["tb"]                     # brightness temperature [K]
  4992                                                   
  4993                                           
  4994                                               # calculate grid spacing assuming a regular lat/lon grid
  4995         1     201892.4 201892.4      0.2      _,_,Area,Gridspacing = calc_grid_distance_area(Lon,Lat)
  4996         1        566.5    566.5      0.0      Area[Area < 0] = 0
  4997                                               
  4998         1          2.3      2.3      0.0      EarthCircum = 40075000 #[m]
  4999         1       3940.7   3940.7      0.0      Lat = np.array(Lat)
  5000         1       2375.8   2375.8      0.0      Lon = np.array(Lon)
  5001         1       3303.6   3303.6      0.0      dLat = np.copy(Lon); dLat[:] = EarthCircum/(360/(Lat[1,0]-Lat[0,0]))
  5002         1       2194.9   2194.9      0.0      dLon = np.copy(Lon)
  5003       722       1086.7      1.5      0.0      for la in range(Lat.shape[0]):
  5004       721       4121.1      5.7      0.0          dLon[la,:] = EarthCircum/(360/(Lat[1,0]-Lat[0,0]))*np.cos(np.deg2rad(Lat[la,0]))
  5005         1       2554.5   2554.5      0.0      dLat = np.abs(dLat)
  5006         1       1034.8   1034.8      0.0      dLon = np.abs(dLon)
  5007                                               
  5008         1        112.6    112.6      0.0      StartDay = Time[0]
  5009         1          4.7      4.7      0.0      SetupString = '_dt-'+str(dT)+'h_MOAAP-masks'
  5010         1          9.5      9.5      0.0      NCfile = params["OutputFolder"] + str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+params["DataName"]+'_ObjectMasks_'+SetupString+'.nc'
  5011         1        588.9    588.9      0.0      FrontMask = np.copy(Mask)
  5012         1          2.6      2.6      0.0      try:
  5013         1       3337.5   3337.5      0.0          FrontMask[np.abs(Lat) < 10] = 0
  5014                                               except:
  5015                                                   print('            latitude does not expand into the tropics')
  5016                                           
  5017                                               # connect over date line?
  5018         1          6.7      6.7      0.0      if (Lon[0,0] < -176) & (Lon[0,-1] > 176):
  5019         1          3.0      3.0      0.0          connectLon= 1
  5020                                               else:
  5021                                                   connectLon= 0
  5022                                           
  5023                                               ### print out which phenomenon can be investigated
  5024         1          2.8      2.8      0.0      if slp is not None:
  5025         1          3.0      3.0      0.0          slp_test = 'yes'
  5026                                               else:
  5027                                                   slp_test = 'no'
  5028         1          3.3      3.3      0.0      if (ivte is not None) & (ivtn is not None):
  5029         1          2.9      2.9      0.0          ar_test = 'yes'
  5030                                               else:
  5031                                                   ar_test = 'no'
  5032         1          3.0      3.0      0.0      if (v850 is not None) & (u850 is not None) & (t850 is not None):
  5033         1          3.2      3.2      0.0          front_test = 'yes'
  5034                                               else:
  5035                                                   front_test = 'no'
  5036         3          9.6      3.2      0.0      if (slp is not None) & (tb is not None) \
  5037         2          5.5      2.7      0.0         & (t850 is not None) & (pr is not None):
  5038         1          3.1      3.1      0.0          tc_test = 'yes'
  5039                                               else:
  5040                                                   tc_test = 'no'
  5041         1          3.1      3.1      0.0      if z500 is not None:
  5042         1          2.9      2.9      0.0          z500_test = 'yes'
  5043                                               else:
  5044                                                   z500_test = 'no'
  5045         2          6.6      3.3      0.0      if (z500 is not None) & (front_test == 'yes') & \
  5046         1          2.8      2.8      0.0         (u200 is not None):
  5047         1          3.3      3.3      0.0          col_test = 'yes'
  5048                                               else:
  5049                                                   col_test = 'no'
  5050         1          3.3      3.3      0.0      if (v200 is not None) & (u200 is not None):
  5051         1          3.1      3.1      0.0          jet_test = 'yes'
  5052                                               else:
  5053                                                   jet_test = 'no'
  5054         1          3.5      3.5      0.0      if (pr is not None) & (tb is not None):
  5055         1          3.2      3.2      0.0          mcs_tb_test = 'yes'
  5056                                               else:
  5057                                                   mcs_tb_test = 'no'
  5058         1          3.3      3.3      0.0      if (pr is not None) & (tb is not None):
  5059         1          3.3      3.3      0.0          cloud_test = 'yes'
  5060                                               else:
  5061                                                   cloud_test = 'no'
  5062         2          7.5      3.8      0.0      if (q850 is not None) & (v850 is not None) & \
  5063         1          3.1      3.1      0.0         (u850 is not None):
  5064         1          3.5      3.5      0.0          ms_test = 'yes'
  5065                                               else:
  5066                                                   ms_test = 'no'
  5067         1          3.6      3.6      0.0      if (pr is not None):
  5068         1          3.6      3.6      0.0          ew_test = 'yes'
  5069                                               else:
  5070                                                   ew_test = 'no'
  5071                                           
  5072         1          3.5      3.5      0.0      """
  5073                                               jet_test =  'no'
  5074                                               slp_test = 'yes'
  5075                                               z500_test =  'no'
  5076                                               col_test = 'no' 
  5077                                               ar_test =  'no'
  5078                                               ms_test =  'no'
  5079                                               front_test =  'no'
  5080                                               tc_test = 'yes'
  5081                                               mcs_tb_test =  'no'
  5082                                               cloud_test =  'no'
  5083                                               ew_test =  'no'
  5084                                               """
  5085         1          3.8      3.8      0.0      ew_test =  'no'
  5086                                               
  5087         1          9.7      9.7      0.0      print(' ')
  5088         1          4.9      4.9      0.0      print('The provided variables allow tracking the following phenomena')
  5089         1          5.0      5.0      0.0      print(' ')
  5090         1          4.1      4.1      0.0      print('|  phenomenon  | tracking |')
  5091         1          4.3      4.3      0.0      print('---------------------------')
  5092         1          4.6      4.6      0.0      print('   Jetstream   |   ' + jet_test)
  5093         1          4.3      4.3      0.0      print('   PSL CY/ACY  |   ' + slp_test)
  5094         1          3.9      3.9      0.0      print('   Z500 CY/ACY |   ' + z500_test)
  5095         1          4.3      4.3      0.0      print('   COLs        |   ' + col_test)
  5096         1          4.4      4.4      0.0      print('   IVT ARs     |   ' + ar_test)
  5097         1          4.4      4.4      0.0      print('   MS ARs      |   ' + ms_test)
  5098         1          4.4      4.4      0.0      print('   Fronts      |   ' + front_test)
  5099         1          4.6      4.6      0.0      print('   TCs         |   ' + tc_test)
  5100         1          4.3      4.3      0.0      print('   MCSs        |   ' + mcs_tb_test)
  5101         1          4.4      4.4      0.0      print('   clouds      |   ' + cloud_test)
  5102         1          4.3      4.3      0.0      print('   Equ. Waves  |   ' + ew_test)
  5103         1          8.1      8.1      0.0      print('---------------------------')
  5104         1          4.3      4.3      0.0      print(' ')
  5105                                           
  5106                                               
  5107         1          6.3      6.3      0.0      import time
  5108                                               
  5109                                               # Mask data outside of Focus domain
  5110         1          3.9      3.9      0.0      try:
  5111         1        586.1    586.1      0.0          v850[:,Mask == 0] = np.nan
  5112                                               except:
  5113                                                   pass
  5114         1          3.8      3.8      0.0      try:
  5115         1        538.7    538.7      0.0          u850[:,Mask == 0] = np.nan
  5116                                               except:
  5117                                                   pass
  5118         1          3.9      3.9      0.0      try:
  5119         1        418.5    418.5      0.0          t850[:,Mask == 0] = np.nan
  5120                                               except:
  5121                                                   pass
  5122         1          4.8      4.8      0.0      try:
  5123         1        463.2    463.2      0.0          q850[:,Mask == 0] = np.nan
  5124                                               except:
  5125                                                   pass
  5126         1          5.7      5.7      0.0      try:
  5127         1        439.8    439.8      0.0          slp[:,Mask == 0]  = np.nan
  5128                                               except:
  5129                                                   pass
  5130         1          4.0      4.0      0.0      try:
  5131         1        357.1    357.1      0.0          ivte[:,Mask == 0] = np.nan
  5132                                               except:
  5133                                                   pass
  5134         1          4.1      4.1      0.0      try:
  5135         1        361.1    361.1      0.0          ivtn[:,Mask == 0] = np.nan
  5136                                               except:
  5137                                                   pass
  5138         1          4.0      4.0      0.0      try:
  5139         1        341.7    341.7      0.0          z500[:,Mask == 0] = np.nan
  5140                                               except:
  5141                                                   pass
  5142         1          4.5      4.5      0.0      try:
  5143         1        343.3    343.3      0.0          v200[:,Mask == 0] = np.nan
  5144                                               except:
  5145                                                   pass
  5146         1          4.3      4.3      0.0      try:
  5147         1        344.8    344.8      0.0          u200[:,Mask == 0] = np.nan
  5148                                               except:
  5149                                                   pass
  5150         1          4.6      4.6      0.0      try:
  5151         1        357.2    357.2      0.0          pr[:,Mask == 0]   = np.nan
  5152                                               except:
  5153                                                   pass
  5154         1          4.3      4.3      0.0      try:
  5155         1        355.3    355.3      0.0          tb[:,Mask == 0]   = np.nan
  5156                                               except:
  5157                                                   pass
  5158                                           
  5159         1          5.4      5.4      0.0      if jet_test == 'yes':
  5160         1          8.6      8.6      0.0          print('======> track jetstream')
  5161         1          8.1      8.1      0.0          start = time.perf_counter()
  5162         1     193955.8 193955.8      0.2          uv200 = (u200 ** 2 + v200 ** 2) ** 0.5
  5163                                           
  5164         2   29486759.2 1.47e+07     24.7          jet_objects, object_split = jetstream_tracking(uv200,
  5165         1          5.8      5.8      0.0                                        params["js_min_anomaly"],
  5166         1          4.5      4.5      0.0                                        params["MinTimeJS"],
  5167         1          4.2      4.2      0.0                                        dT,
  5168         1          4.2      4.2      0.0                                        Gridspacing,
  5169         1          4.2      4.2      0.0                                        connectLon,
  5170         1          4.6      4.6      0.0                                        breakup = params["breakup_jet"])
  5171         2    2398700.5  1.2e+06      2.0          jet_objects_characteristics = calc_object_characteristics(jet_objects, # feature object file
  5172         1          4.8      4.8      0.0                                       uv200,         # original file used for feature detection
  5173         1         17.0     17.0      0.0                                       params["OutputFolder"]+'jet_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5174         1          4.9      4.9      0.0                                       Time,            # timesteps of the data
  5175         1          4.6      4.6      0.0                                       Lat,             # 2D latidudes
  5176         1          4.7      4.7      0.0                                       Lon,             # 2D Longitudes
  5177         1          4.4      4.4      0.0                                       Gridspacing,
  5178         1          4.4      4.4      0.0                                       Area,
  5179         1          6.2      6.2      0.0                                       min_tsteps=int(params["MinTimeJS"]/dT),
  5180         1          4.7      4.7      0.0                                       split_merge = object_split)
  5181                                                   
  5182         1         11.5     11.5      0.0          end = time.perf_counter()
  5183         1         46.3     46.3      0.0          timer(start, end)
  5184                                                   
  5185                                               
  5186         1         12.2     12.2      0.0      if ew_test == 'yes':
  5187                                                   print('======> track tropical waves')
  5188                                                   start = time.perf_counter()
  5189                                                   mrg_objects, igw_objects, kelvin_objects, eig0_objects, er_objects = track_tropwaves_tb(
  5190                                                                   tb,
  5191                                                                   Lat,
  5192                                                                   connectLon,
  5193                                                                   dT,
  5194                                                                  Gridspacing,
  5195                                                                  er_th = params["er_th"],  # threshold for Rossby Waves
  5196                                                                  mrg_th = params["mrg_th"], # threshold for mixed Rossby Gravity Waves
  5197                                                                  igw_th = params["igw_th"],  # threshold for inertia gravity waves
  5198                                                                  kel_th = params["kel_th"],  # threshold for Kelvin waves
  5199                                                                  eig0_th = params["eig0_th"], # threshold for n>=1 Inertio Gravirt Wave
  5200                                                                  breakup = params["breakup_tw"]
  5201                                                                   )
  5202                                                   end = time.perf_counter()
  5203                                                   timer(start, end)
  5204                                           
  5205                                                   gr_mrg = calc_object_characteristics(mrg_objects, # feature object file
  5206                                                                            pr,         # original file used for feature detection
  5207                                                                            params["OutputFolder"]+'MRG_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5208                                                                            Time,            # timesteps of the data
  5209                                                                            Lat,             # 2D latidudes
  5210                                                                            Lon,             # 2D Longitudes
  5211                                                                            Gridspacing,
  5212                                                                            Area,
  5213                                                                            min_tsteps=int(params["tropwave_minTime"]/dT))      # minimum livetime in hours
  5214                                                   
  5215                                                   gr_igw = calc_object_characteristics(igw_objects, # feature object file
  5216                                                                            pr,         # original file used for feature detection
  5217                                                                            params["OutputFolder"]+'IGW_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5218                                                                            Time,            # timesteps of the data
  5219                                                                            Lat,             # 2D latidudes
  5220                                                                            Lon,             # 2D Longitudes
  5221                                                                            Gridspacing,
  5222                                                                            Area,
  5223                                                                            min_tsteps=int(48/dT))      # minimum livetime in hours
  5224                                                   
  5225                                                   gr_kelvin = calc_object_characteristics(kelvin_objects, # feature object file
  5226                                                                            pr,         # original file used for feature detection
  5227                                                                            params["OutputFolder"]+'Kelvin_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5228                                                                            Time,            # timesteps of the data
  5229                                                                            Lat,             # 2D latidudes
  5230                                                                            Lon,             # 2D Longitudes
  5231                                                                            Gridspacing,
  5232                                                                            Area,
  5233                                                                            min_tsteps=int(48/dT))      # minimum livetime in hours
  5234                                                   
  5235                                                   gr_eig0 = calc_object_characteristics(eig0_objects, # feature object file
  5236                                                                            pr,         # original file used for feature detection
  5237                                                                            params["OutputFolder"]+'Eig0_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5238                                                                            Time,            # timesteps of the data
  5239                                                                            Lat,             # 2D latidudes
  5240                                                                            Lon,             # 2D Longitudes
  5241                                                                            Gridspacing,
  5242                                                                            Area,
  5243                                                                            min_tsteps=int(48/dT))      # minimum livetime in hours
  5244                                                   
  5245                                                   gr_er = calc_object_characteristics(er_objects, # feature object file
  5246                                                                            pr,         # original file used for feature detection
  5247                                                                            params["OutputFolder"]+'ER_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5248                                                                            Time,            # timesteps of the data
  5249                                                                            Lat,             # 2D latidudes
  5250                                                                            Lon,             # 2D Longitudes
  5251                                                                            Gridspacing,
  5252                                                                            Area,
  5253                                                                            min_tsteps=int(48/dT))      # minimum livetime in hours
  5254                                                   
  5255                                                   
  5256         1         11.8     11.8      0.0      if ms_test == 'yes':
  5257         1         12.6     12.6      0.0          print('======> track moisture streams and atmospheric rivers (ARs)')
  5258         1         11.8     11.8      0.0          start = time.perf_counter()
  5259         3     280075.8  93358.6      0.2          VapTrans = ((u850 * q850)**2 + 
  5260         2     118507.6  59253.8      0.1                      (v850 * q850)**2)**(1/2)
  5261                                           
  5262         2    4876591.7 2.44e+06      4.1          MS_objects = ar_850hpa_tracking(
  5263         1         11.0     11.0      0.0                                          VapTrans,
  5264         1         10.9     10.9      0.0                                          params["MinMSthreshold"],
  5265         1         10.3     10.3      0.0                                          params["MinTimeMS"],
  5266         1         10.7     10.7      0.0                                          params["MinAreaMS"],
  5267         1          9.8      9.8      0.0                                          Area,
  5268         1          9.8      9.8      0.0                                          dT,
  5269         1          9.8      9.8      0.0                                          connectLon,
  5270         1         10.6     10.6      0.0                                          Gridspacing,
  5271         1         10.4     10.4      0.0                                          breakup = params["breakup_ivt"])
  5272                                                   
  5273         2     796569.8 398284.9      0.7          grMSs = calc_object_characteristics(MS_objects, # feature object file
  5274         1          7.3      7.3      0.0                                   VapTrans,         # original file used for feature detection
  5275         1         23.0     23.0      0.0                                   params["OutputFolder"]+'MS850_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,        # output file name and locaiton
  5276         1          7.0      7.0      0.0                                   Time,            # timesteps of the data
  5277         1          6.8      6.8      0.0                                   Lat,             # 2D latidudes
  5278         1         13.6     13.6      0.0                                   Lon,             # 2D Longitudes
  5279         1          6.8      6.8      0.0                                   Gridspacing,
  5280         1          6.6      6.6      0.0                                   Area,
  5281         1          8.4      8.4      0.0                                   min_tsteps=int(params["MinTimeMS"]/dT))      # minimum livetime in hours
  5282                                                   
  5283         1         18.2     18.2      0.0          end = time.perf_counter()
  5284         1         58.2     58.2      0.0          timer(start, end)
  5285                                                   
  5286                                               
  5287         1         13.5     13.5      0.0      if ar_test == 'yes':
  5288         1         11.7     11.7      0.0          print('======> track IVT streams and atmospheric rivers (ARs)')
  5289         1         11.9     11.9      0.0          start = time.perf_counter()
  5290         1     218666.8 218666.8      0.2          IVT = (ivte ** 2 + ivtn ** 2) ** 0.5
  5291                                           
  5292         2    2513323.0 1.26e+06      2.1          IVT_objects = ar_ivt_tracking(IVT,
  5293         1         14.4     14.4      0.0                                      params["IVTtrheshold"],
  5294         1         13.3     13.3      0.0                                      params["MinTimeIVT"],
  5295         1         13.0     13.0      0.0                                      dT,
  5296         1         13.4     13.4      0.0                                      Gridspacing,
  5297         1         12.8     12.8      0.0                                      connectLon,
  5298         1         13.4     13.4      0.0                                      breakup = params["breakup_ivt"])
  5299                                           
  5300         2     326571.4 163285.7      0.3          grIVTs = calc_object_characteristics(IVT_objects, # feature object file
  5301         1          8.0      8.0      0.0                                       IVT,         # original file used for feature detection
  5302         1         17.7     17.7      0.0                                       params["OutputFolder"]+'IVT_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5303         1          7.6      7.6      0.0                                       Time,            # timesteps of the data
  5304         1          7.4      7.4      0.0                                       Lat,             # 2D latidudes
  5305         1          7.6      7.6      0.0                                       Lon,             # 2D Longitudes
  5306         1          7.4      7.4      0.0                                       Gridspacing,
  5307         1          7.2      7.2      0.0                                       Area,
  5308         1          9.1      9.1      0.0                                       min_tsteps=int(params["MinTimeIVT"]/dT))      # minimum livetime in hours
  5309                                                   
  5310         1         13.3     13.3      0.0          print('        check if MSs quallify as ARs')
  5311         2     571653.6 285826.8      0.5          AR_obj = ar_check(IVT_objects,
  5312         1          8.1      8.1      0.0                           params["AR_Lat"],
  5313         1          7.7      7.7      0.0                           params["AR_width_lenght_ratio"],
  5314         1          7.3      7.3      0.0                           params["AR_MinLen"],
  5315         1          7.1      7.1      0.0                           Lon,
  5316         1          7.1      7.1      0.0                           Lat)
  5317                                               
  5318         2     263276.1 131638.0      0.2          grACs = calc_object_characteristics(AR_obj, # feature object file
  5319         1         12.0     12.0      0.0                           IVT,         # original file used for feature detection
  5320         1         23.2     23.2      0.0                           params["OutputFolder"]+'ARs_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5321         1         10.3     10.3      0.0                           Time,            # timesteps of the data
  5322         1         10.6     10.6      0.0                           Lat,             # 2D latidudes
  5323         1         10.6     10.6      0.0                           Lon,             # 2D Longitudes
  5324         1         10.3     10.3      0.0                           Gridspacing,
  5325         1         10.2     10.2      0.0                           Area)
  5326                                                   
  5327         1         12.6     12.6      0.0          end = time.perf_counter()
  5328         1         34.0     34.0      0.0          timer(start, end)
  5329                                               
  5330         1          9.8      9.8      0.0      if front_test == 'yes':
  5331         1         12.8     12.8      0.0          print('======> identify frontal zones')
  5332         1          9.3      9.3      0.0          start = time.perf_counter()
  5333                                                   
  5334                                                   # -------
  5335         1          9.4      9.4      0.0          dx = dLon
  5336         1          9.0      9.0      0.0          dy = dLat
  5337         1     530594.0 530594.0      0.4          du = np.gradient( np.array(u850) )
  5338         1    1361592.9 1.36e+06      1.1          dv = np.gradient( np.array(v850) )
  5339         1     523188.5 523188.5      0.4          PV = np.abs( dv[-1]/dx[None,:] - du[-2]/dy[None,:] )
  5340         1    1242458.7 1.24e+06      1.0          vgrad = np.gradient(np.array(t850), axis=(1,2))
  5341         1     517554.4 517554.4      0.4          Tgrad = np.sqrt(vgrad[0]**2 + vgrad[1]**2)
  5342                                           
  5343         1      64719.8  64719.8      0.1          Fstar = PV * Tgrad
  5344                                           
  5345         1         11.4     11.4      0.0          Tgrad_zero = 0.45 #*100/(np.mean([dLon,dLat], axis=0)/1000.)  # 0.45 K/(100 km)
  5346         1         26.0     26.0      0.0          import metpy.calc as calc
  5347         1         15.8     15.8      0.0          from metpy.units import units
  5348         1      16394.5  16394.5      0.0          CoriolisPar = np.array(calc.coriolis_parameter(np.deg2rad(Lat)))
  5349         1     351808.7 351808.7      0.3          Frontal_Diagnostic = np.array(Fstar/(CoriolisPar * Tgrad_zero))
  5350                                                   
  5351         1        767.3    767.3      0.0          FrontMask = np.copy(Mask)
  5352         1       3566.7   3566.7      0.0          FrontMask[np.abs(Lat) < 10] = 0
  5353                                                   
  5354         1      60718.7  60718.7      0.1          Frontal_Diagnostic = np.abs(Frontal_Diagnostic)
  5355         1       7364.0   7364.0      0.0          Frontal_Diagnostic[:,FrontMask == 0] = 0
  5356                                                   # -------
  5357                                                   
  5358                                                   
  5359         2    1417717.1 708858.6      1.2          FR_objects = frontal_identification(Frontal_Diagnostic,
  5360         1         11.3     11.3      0.0                                params["front_treshold"],
  5361         1          9.0      9.0      0.0                                params["MinAreaFR"],
  5362         1          8.6      8.6      0.0                                Area)
  5363                                                   
  5364         1         21.9     21.9      0.0          end = time.perf_counter()
  5365         1         66.1     66.1      0.0          timer(start, end)
  5366                                                   
  5367         1         13.5     13.5      0.0      if slp_test == 'yes':
  5368         1         10.8     10.8      0.0          print('======> track cyclones from PSL')
  5369         1          8.9      8.9      0.0          start = time.perf_counter()
  5370                                                   
  5371         2   13429416.3 6.71e+06     11.3          CY_objects, ACY_objects= cy_acy_psl_tracking(
  5372         1          9.5      9.5      0.0                                                      slp,
  5373         1         11.3     11.3      0.0                                                      params["MaxPresAnCY"],
  5374         1          9.7      9.7      0.0                                                      params["MinTimeCY"],
  5375         1          9.4      9.4      0.0                                                      params["MinPresAnACY"],
  5376         1          9.2      9.2      0.0                                                      params["MinTimeACY"],
  5377         1          9.8      9.8      0.0                                                      dT,
  5378         1          9.2      9.2      0.0                                                      Gridspacing,
  5379         1          9.3      9.3      0.0                                                      connectLon,
  5380         1          8.4      8.4      0.0                                                      breakup = params["breakup_cy"],
  5381                                                                                               )
  5382                                           
  5383         2     446620.1 223310.1      0.4          grCyclonesPT = calc_object_characteristics(CY_objects, # feature object file
  5384         1         11.0     11.0      0.0                                           slp,         # original file used for feature detection
  5385         1         34.6     34.6      0.0                                           params["OutputFolder"]+'CY_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5386         1          9.7      9.7      0.0                                           Time,            # timesteps of the data
  5387         1         10.0     10.0      0.0                                           Lat,             # 2D latidudes
  5388         1          9.8      9.8      0.0                                           Lon,             # 2D Longitudes
  5389         1         17.2     17.2      0.0                                           Gridspacing,
  5390         1          9.4      9.4      0.0                                           Area,
  5391         1         12.2     12.2      0.0                                           min_tsteps=int(params["MinTimeCY"]/dT)) 
  5392                                           
  5393         2     687055.2 343527.6      0.6          grACyclonesPT = calc_object_characteristics(ACY_objects, # feature object file
  5394         1          9.5      9.5      0.0                                           slp,         # original file used for feature detection
  5395         1         20.2     20.2      0.0                                           params["OutputFolder"]+'ACY_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5396         1          9.3      9.3      0.0                                           Time,            # timesteps of the data
  5397         1          8.9      8.9      0.0                                           Lat,             # 2D latidudes
  5398         1          9.3      9.3      0.0                                           Lon,             # 2D Longitudes
  5399         1          9.0      9.0      0.0                                           Gridspacing,
  5400         1          9.0      9.0      0.0                                           Area,
  5401         1         10.4     10.4      0.0                                           min_tsteps=int(params["MinTimeCY"]/dT)) 
  5402                                           
  5403         1         13.7     13.7      0.0          end = time.perf_counter()
  5404         1         33.6     33.6      0.0          timer(start, end)
  5405                                           
  5406         1          9.8      9.8      0.0      if z500_test == 'yes':
  5407         1         10.3     10.3      0.0          print('======> track cyclones from Z500')
  5408         1          9.8      9.8      0.0          start = time.perf_counter()
  5409         2   10054772.8 5.03e+06      8.4          cy_z500_objects, acy_z500_objects = cy_acy_z500_tracking(
  5410         1          9.4      9.4      0.0                                              z500,
  5411         1          9.7      9.7      0.0                                              params["MinTimeCY"],
  5412         1          9.4      9.4      0.0                                              dT,
  5413         1          9.5      9.5      0.0                                              Gridspacing,
  5414         1          8.8      8.8      0.0                                              connectLon,
  5415         1          9.7      9.7      0.0                                              z500_low_anom = params["z500_low_anom"],
  5416         1          9.2      9.2      0.0                                              z500_high_anom = params["z500_high_anom"],
  5417         1          9.3      9.3      0.0                                              breakup = params["breakup_zcy"],
  5418                                                                                       )
  5419                                                   
  5420         2     512778.5 256389.3      0.4          cy_z500_objects_characteristics = calc_object_characteristics(cy_z500_objects, # feature object file
  5421         1         11.0     11.0      0.0                                       z500,         # original file used for feature detection
  5422         1         26.0     26.0      0.0                                       params["OutputFolder"]+'CY-z500_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5423         1         11.0     11.0      0.0                                       Time,            # timesteps of the data
  5424         1         10.1     10.1      0.0                                       Lat,             # 2D latidudes
  5425         1         10.1     10.1      0.0                                       Lon,             # 2D Longitudes
  5426         1         10.0     10.0      0.0                                       Gridspacing,
  5427         1         10.1     10.1      0.0                                       Area,
  5428         1         12.3     12.3      0.0                                       min_tsteps=int(params["MinTimeCY"]/dT))
  5429                                                   
  5430         2     517003.6 258501.8      0.4          acy_z500_objects_characteristics = calc_object_characteristics(acy_z500_objects, # feature object file
  5431         1          9.9      9.9      0.0                                   z500,         # original file used for feature detection
  5432         1         20.4     20.4      0.0                                   params["OutputFolder"]+'ACY-z500_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5433         1          9.8      9.8      0.0                                   Time,            # timesteps of the data
  5434         1         10.0     10.0      0.0                                   Lat,             # 2D latidudes
  5435         1          9.8      9.8      0.0                                   Lon,             # 2D Longitudes
  5436         1         10.2     10.2      0.0                                   Gridspacing,
  5437         1          9.6      9.6      0.0                                   Area,
  5438         1         10.8     10.8      0.0                                   min_tsteps=int(params["MinTimeCY"]/dT)) 
  5439                                                   
  5440         1         17.6     17.6      0.0          if col_test == 'yes':
  5441         1         17.4     17.4      0.0              print('    Check if cyclones qualify as Cut Off Low (COL)')
  5442         2     864654.4 432327.2      0.7              col_obj = col_identification(cy_z500_objects,
  5443         1         11.0     11.0      0.0                                     z500,
  5444         1         10.2     10.2      0.0                                     u200,
  5445         1         10.5     10.5      0.0                                     Frontal_Diagnostic,
  5446         1         11.4     11.4      0.0                                     params["MinTimeC"],
  5447         1         10.4     10.4      0.0                                     dx,
  5448         1         10.4     10.4      0.0                                     dy,
  5449         1         10.2     10.2      0.0                                     Lon,
  5450         1         10.2     10.2      0.0                                     Lat)
  5451                                           
  5452         2     201150.4 100575.2      0.2              col_stats = calc_object_characteristics(col_obj, # feature object file
  5453         1      42372.0  42372.0      0.0                               z500*9.81,            # original file used for feature detection
  5454         1         26.3     26.3      0.0                               params["OutputFolder"]+'COL_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5455         1         11.9     11.9      0.0                               Time,            # timesteps of the data
  5456         1         11.6     11.6      0.0                               Lat,             # 2D latidudes
  5457         1         11.5     11.5      0.0                               Lon,             # 2D Longitudes
  5458         1         10.9     10.9      0.0                               Gridspacing,
  5459         1         14.7     14.7      0.0                               Area,
  5460         1         10.9     10.9      0.0                               min_tsteps=1)      # minimum livetime in hours
  5461                                           
  5462         1         17.4     17.4      0.0          end = time.perf_counter()
  5463         1         37.1     37.1      0.0          timer(start, end)
  5464                                           
  5465                                           
  5466         1         13.0     13.0      0.0      if mcs_tb_test == 'yes':
  5467         1         13.5     13.5      0.0          print("======> 'check if Tb objects qualify as MCS (or selected storm type)")
  5468         1         12.1     12.1      0.0          start = time.perf_counter()
  5469         2    5461503.3 2.73e+06      4.6          MCS_objects_Tb, C_objects = mcs_tb_tracking(tb,
  5470         1         12.5     12.5      0.0                              pr,
  5471         1         12.5     12.5      0.0                              params["SmoothSigmaC"],
  5472         1         12.1     12.1      0.0                              params["Pthreshold"],
  5473         1         12.3     12.3      0.0                              params["CL_Area"],
  5474         1         12.0     12.0      0.0                              params["CL_MaxT"],
  5475         1         12.2     12.2      0.0                              params["Cthreshold"],
  5476         1         12.6     12.6      0.0                              params["MinAreaC"],
  5477         1         11.9     11.9      0.0                              params["MinTimeC"],
  5478         1         11.9     11.9      0.0                              params["MCS_minPR"],
  5479         1         11.9     11.9      0.0                              params["MCS_minTime"],
  5480         1         12.1     12.1      0.0                              params["MCS_Minsize"],
  5481         1         11.9     11.9      0.0                              dT,
  5482         1         12.1     12.1      0.0                              Area,
  5483         1         11.8     11.8      0.0                              connectLon,
  5484         1         12.3     12.3      0.0                              Gridspacing,                 
  5485         1         12.0     12.0      0.0                              breakup=params["breakup_mcs"],
  5486                                                                      )
  5487                                                   
  5488         2    3929478.3 1.96e+06      3.3          grCs = calc_object_characteristics(C_objects, # feature object file
  5489         1         12.3     12.3      0.0                               tb,         # original file used for feature detection
  5490         1         34.8     34.8      0.0                               params["OutputFolder"]+'Clouds_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5491         1         11.8     11.8      0.0                               Time,            # timesteps of the data
  5492         1         11.8     11.8      0.0                               Lat,             # 2D latidudes
  5493         1         11.4     11.4      0.0                               Lon,             # 2D Longitudes
  5494         1         11.3     11.3      0.0                               Gridspacing,
  5495         1         11.3     11.3      0.0                               Area,
  5496         1         14.2     14.2      0.0                               min_tsteps=int(params["MinTimeC"]/dT))      # minimum livetime in hours
  5497                                                   
  5498         2     383575.0 191787.5      0.3          grMCSs_Tb = calc_object_characteristics(
  5499         1         21.0     21.0      0.0              MCS_objects_Tb,  # feature object file
  5500         1         21.6     21.6      0.0              pr,  # original file used for feature detection
  5501         1         33.4     33.4      0.0              params["OutputFolder"]+'MCSs_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5502         1         20.4     20.4      0.0              Time,            # timesteps of the data
  5503         1         20.9     20.9      0.0              Lat,             # 2D latidudes
  5504         1         20.6     20.6      0.0              Lon,             # 2D Longitudes
  5505         1         19.8     19.8      0.0              Gridspacing,
  5506         1         19.3     19.3      0.0              Area)
  5507                                                   
  5508         1         15.6     15.6      0.0          end = time.perf_counter()
  5509         1         33.9     33.9      0.0          timer(start, end)
  5510                                           
  5511                                               
  5512         1         12.7     12.7      0.0      if cloud_test == "yes":
  5513         1         12.4     12.4      0.0          print("======> 'track high clouds in Tb field by excluding MCS objects")
  5514         1         11.7     11.7      0.0          start = time.perf_counter()
  5515         1      36404.4  36404.4      0.0          tb_no_mcs = tb.copy()
  5516         1      44958.5  44958.5      0.0          tb_no_mcs[MCS_objects_Tb > 0] = 330 # remove MCSs from cloud field
  5517                                                   
  5518         2    2661634.3 1.33e+06      2.2          cloud_objects = cloud_tracking(
  5519         1         12.8     12.8      0.0                          tb_no_mcs,
  5520         1         12.1     12.1      0.0                          pr,
  5521         1         11.7     11.7      0.0                          connectLon,
  5522         1         11.8     11.8      0.0                          Gridspacing,
  5523         1         11.1     11.1      0.0                          dT,
  5524         1         12.6     12.6      0.0                          tb_threshold = params["Cthreshold"],
  5525         1         11.8     11.8      0.0                          tb_overshoot = params["cloud_overshoot"],
  5526         1         11.2     11.2      0.0                          erosion_disk = 1.5,
  5527         1         10.8     10.8      0.0                          min_dist = 8
  5528                                                                   )
  5529                                           
  5530         2    1335529.4 667764.7      1.1          grclouds_Tb = calc_object_characteristics(
  5531         1         13.2     13.2      0.0              cloud_objects,  # feature object file
  5532         1         13.3     13.3      0.0              pr,  # original file used for feature detection
  5533         1         40.4     40.4      0.0              params["OutputFolder"]+'non-MCS-clouds_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5534         1         13.3     13.3      0.0              Time,            # timesteps of the data
  5535         1         12.3     12.3      0.0              Lat,             # 2D latidudes
  5536         1         12.3     12.3      0.0              Lon,             # 2D Longitudes
  5537         1         12.4     12.4      0.0              Gridspacing,
  5538         1         12.4     12.4      0.0              Area)
  5539                                                   
  5540         1         17.1     17.1      0.0          end = time.perf_counter()
  5541         1         85.3     85.3      0.0          timer(start, end)
  5542                                                   
  5543         1         13.1     13.1      0.0      if tc_test == 'yes':
  5544         1         13.7     13.7      0.0          print('======> Check if cyclones qualify as TCs')
  5545         1         12.0     12.0      0.0          start = time.perf_counter()
  5546                                           
  5547         2     537501.2 268750.6      0.5          TC_obj, TC_Tracks = tc_tracking(CY_objects,
  5548         1         11.6     11.6      0.0                                          slp,
  5549         1         13.1     13.1      0.0                          t850,
  5550         1         15.2     15.2      0.0                          tb,
  5551         1     195398.2 195398.2      0.2                          np.sqrt(u850**2 + v850**2),
  5552         1     192184.2 192184.2      0.2                          np.sqrt(u200**2 + v200**2),
  5553         1         15.9     15.9      0.0                          Lon,
  5554         1         12.7     12.7      0.0                          Lat,
  5555         1         14.0     14.0      0.0                          params["TC_lat_genesis"],
  5556         1         12.7     12.7      0.0                          params["TC_T850min"]
  5557                                                                  )
  5558         1         15.3     15.3      0.0          """
  5559                                                   TC_obj, TC_Tracks = tc_tracking(CY_objects,
  5560                                                                   t850,
  5561                                                                   slp,
  5562                                                                   tb,
  5563                                                                   C_objects,
  5564                                                                   Lon,
  5565                                                                   Lat,
  5566                                                                   params["TC_lat_genesis"],
  5567                                                                   params["TC_deltaT_core"],
  5568                                                                   params["TC_T850min"],
  5569                                                                   params["TC_Pmin"],
  5570                                                                   params["TC_lat_max"],
  5571                                                                  )
  5572                                                   """
  5573                                           
  5574                                                   
  5575         2      99920.9  49960.4      0.1          grTCs = calc_object_characteristics(TC_obj, # feature object file
  5576         1      42597.3  42597.3      0.0                               slp*100.,         # original file used for feature detection
  5577         1         27.9     27.9      0.0                               params["OutputFolder"]+'TC_'+str(StartDay.year)+str(StartDay.month).zfill(2)+'_'+SetupString,
  5578         1         13.7     13.7      0.0                               Time,            # timesteps of the data
  5579         1         13.9     13.9      0.0                               Lat,             # 2D latidudes
  5580         1         13.7     13.7      0.0                               Lon,             # 2D Longitudes
  5581         1         13.1     13.1      0.0                               Gridspacing,
  5582         1         13.0     13.0      0.0                               Area,
  5583         1         16.3     16.3      0.0                               min_tsteps=int(params["MinTimeC"]/dT))      # minimum livetime in hours
  5584                                                   ### SAVE THE TC TRACKS TO PICKL FILE
  5585         1        259.0    259.0      0.0          a_file = open(params["OutputFolder"]+str(Time[0].year)+str(Time[0].month).zfill(2)+'_TCs_tracks.pkl', "wb")
  5586         1         22.2     22.2      0.0          pickle.dump(TC_Tracks, a_file)
  5587         1         77.0     77.0      0.0          a_file.close()
  5588                                                   
  5589         1         25.3     25.3      0.0          end = time.perf_counter()
  5590         1         38.8     38.8      0.0          timer(start, end)  
  5591                                                   
  5592                                               
  5593                                           
  5594                                           
  5595         1         14.2     14.2      0.0      print(' ')
  5596         1         13.0     13.0      0.0      print('Save the object masks into a joint netCDF')
  5597         1         13.1     13.1      0.0      start = time.perf_counter()
  5598                                               # ============================
  5599                                               # Write NetCDF
  5600         1        987.8    987.8      0.0      iTime = np.array((Time - Time[0]).total_seconds()).astype('int')
  5601                                           
  5602         1      30872.5  30872.5      0.0      dataset = Dataset(NCfile,'w',format='NETCDF4_CLASSIC')
  5603         1        266.8    266.8      0.0      yc = dataset.createDimension('yc', Lat.shape[0])
  5604         1         94.3     94.3      0.0      xc = dataset.createDimension('xc', Lat.shape[1])
  5605         1        139.8    139.8      0.0      time = dataset.createDimension('time', None)
  5606                                           
  5607         1        375.2    375.2      0.0      times = dataset.createVariable('time', np.float64, ('time',))
  5608         1        328.4    328.4      0.0      lat = dataset.createVariable('lat', np.float32, ('yc','xc',))
  5609         1        404.9    404.9      0.0      lon = dataset.createVariable('lon', np.float32, ('yc','xc',))
  5610         1         15.2     15.2      0.0      if mcs_tb_test == 'yes':
  5611         1        334.5    334.5      0.0          PR_real = dataset.createVariable('PR', np.float32,('time','yc','xc'),zlib=True)
  5612                                                   # PR_obj = dataset.createVariable('PR_Objects', np.float32,('time','yc','xc'),zlib=True)
  5613                                                   # MCSs = dataset.createVariable('MCS_Objects', np.float32,('time','yc','xc'),zlib=True)
  5614         1        320.6    320.6      0.0          MCSs_Tb = dataset.createVariable('MCS_Tb_Objects', np.float32,('time','yc','xc'),zlib=True)
  5615         1        295.7    295.7      0.0          Cloud_real = dataset.createVariable('BT', np.float32,('time','yc','xc'),zlib=True)
  5616                                                   # Cloud_obj = dataset.createVariable('BT_Objects', np.float32,('time','yc','xc'),zlib=True)
  5617         1         15.6     15.6      0.0      if cloud_test == "yes":
  5618         1        372.7    372.7      0.0          non_mcs_cloud_obj = dataset.createVariable('non_mcs_cloud_Objects', np.float32,('time','yc','xc'),zlib=True)
  5619         1         15.9     15.9      0.0      if front_test == 'yes':
  5620         1        296.3    296.3      0.0          FR_real = dataset.createVariable('FR', np.float32,('time','yc','xc'),zlib=True)
  5621         1        316.4    316.4      0.0          FR_obj = dataset.createVariable('FR_Objects', np.float32,('time','yc','xc'),zlib=True)
  5622         1        311.4    311.4      0.0          T_real = dataset.createVariable('T850', np.float32,('time','yc','xc'),zlib=True)
  5623         1         15.1     15.1      0.0      if slp_test == 'yes':
  5624         1        381.1    381.1      0.0          CY_obj = dataset.createVariable('CY_Objects', np.float32,('time','yc','xc'),zlib=True)
  5625         1        288.7    288.7      0.0          ACY_obj = dataset.createVariable('ACY_Objects', np.float32,('time','yc','xc'),zlib=True)
  5626         1        271.7    271.7      0.0          SLP_real = dataset.createVariable('SLP', np.float32,('time','yc','xc'),zlib=True)
  5627         1         14.9     14.9      0.0      if tc_test == 'yes':
  5628         1        274.6    274.6      0.0          TCs = dataset.createVariable('TC_Objects', np.float32,('time','yc','xc'),zlib=True)
  5629         1         15.5     15.5      0.0      if ms_test == 'yes':
  5630         1        524.9    524.9      0.0          MS_real = dataset.createVariable('MS', np.float32,('time','yc','xc'),zlib=True)
  5631         1        296.7    296.7      0.0          MS_obj = dataset.createVariable('MS_Objects', np.float32,('time','yc','xc'),zlib=True)
  5632         1         14.8     14.8      0.0      if ar_test == 'yes':
  5633         1        291.8    291.8      0.0          IVT_real = dataset.createVariable('IVT', np.float32,('time','yc','xc'),zlib=True)
  5634         1        333.1    333.1      0.0          IVT_obj = dataset.createVariable('IVT_Objects', np.float32,('time','yc','xc'),zlib=True)
  5635         1        299.7    299.7      0.0          ARs = dataset.createVariable('AR_Objects', np.float32,('time','yc','xc'),zlib=True)
  5636         1         15.2     15.2      0.0      if z500_test == 'yes':
  5637         1        282.2    282.2      0.0          CY_z500_obj = dataset.createVariable('CY_z500_Objects', np.float32,('time','yc','xc'),zlib=True)
  5638         1        306.6    306.6      0.0          ACY_z500_obj = dataset.createVariable('ACY_z500_Objects', np.float32,('time','yc','xc'),zlib=True)
  5639         1        296.2    296.2      0.0          Z500_real = dataset.createVariable('Z500', np.float32,('time','yc','xc'),zlib=True)
  5640         1         15.6     15.6      0.0      if col_test == 'yes':
  5641         1        277.4    277.4      0.0          COL = dataset.createVariable('COL_Objects', np.float32,('time','yc','xc'),zlib=True)
  5642         1         15.4     15.4      0.0      if jet_test == 'yes':
  5643         1        286.1    286.1      0.0          JET = dataset.createVariable('JET_Objects', np.float32,('time','yc','xc'),zlib=True)
  5644         1        289.9    289.9      0.0          UV200 = dataset.createVariable('UV200', np.float32,('time','yc','xc'),zlib=True)
  5645         1         16.5     16.5      0.0      if ew_test == 'yes':
  5646                                                   MRG = dataset.createVariable('MRG_Objects', np.float32,('time','yc','xc'),zlib=True)
  5647                                                   IGW = dataset.createVariable('IGW_Objects', np.float32,('time','yc','xc'),zlib=True)
  5648                                                   KELVIN = dataset.createVariable('Kelvin_Objects', np.float32,('time','yc','xc'),zlib=True)
  5649                                                   EIG = dataset.createVariable('EIG0_Objects', np.float32,('time','yc','xc'),zlib=True)
  5650                                                   ER = dataset.createVariable('ER_Objects', np.float32,('time','yc','xc'),zlib=True)
  5651                                                   
  5652                                           
  5653         1         93.5     93.5      0.0      times.calendar = "standard"
  5654         1        235.0    235.0      0.0      times.units = "seconds since "+str(Time[0].year)+"-"+str(Time[0].month).zfill(2)+"-"+str(Time[0].day).zfill(2)+" "+str(Time[0].hour).zfill(2)+":"+str(Time[0].minute).zfill(2)+":00"
  5655         1         53.6     53.6      0.0      times.standard_name = "time"
  5656         1        129.3    129.3      0.0      times.long_name = "time"
  5657                                           
  5658         1         58.0     58.0      0.0      lat.long_name = "latitude" ;
  5659         1         53.7     53.7      0.0      lat.units = "degrees_north" ;
  5660         1         45.2     45.2      0.0      lat.standard_name = "latitude" ;
  5661                                           
  5662         1         49.7     49.7      0.0      lon.long_name = "longitude" ;
  5663         1         48.1     48.1      0.0      lon.units = "degrees_east" ;
  5664         1         41.4     41.4      0.0      lon.standard_name = "longitude" ;
  5665                                           
  5666         1         15.9     15.9      0.0      if mcs_tb_test == 'yes':
  5667         1         38.2     38.2      0.0          PR_real.coordinates = "lon lat"
  5668         1         36.5     36.5      0.0          PR_real.longname = "precipitation"
  5669         1         42.0     42.0      0.0          PR_real.unit = "mm/"+str(dT)+"h"
  5670                                                   
  5671                                                   # PR_obj.coordinates = "lon lat"
  5672                                                   # PR_obj.longname = "precipitation objects"
  5673                                                   # PR_obj.unit = ""
  5674                                                   
  5675                                           #         MCSs.coordinates = "lon lat"
  5676                                           #         MCSs.longname = "MCSs object defined by their precipitation"
  5677                                           #         MCSs.unit = ""
  5678                                                   
  5679         1         41.3     41.3      0.0          MCSs_Tb.coordinates = "lon lat"
  5680         1         39.8     39.8      0.0          MCSs_Tb.longname = "MCSs object defined by their Tb"
  5681         1         40.7     40.7      0.0          MCSs_Tb.unit = ""
  5682                                                   
  5683         1         40.2     40.2      0.0          Cloud_real.coordinates = "lon lat"
  5684         1         42.1     42.1      0.0          Cloud_real.longname = "Tb"
  5685         1         39.4     39.4      0.0          Cloud_real.unit = "K"
  5686                                                   
  5687                                                   # Cloud_obj.coordinates = "lon lat"
  5688                                                   # Cloud_obj.longname = "Tb objects"
  5689                                                   # Cloud_obj.unit = ""
  5690         1         16.0     16.0      0.0      if cloud_test == 'yes':
  5691         1         40.4     40.4      0.0          non_mcs_cloud_obj.coordinates = "lon lat"
  5692         1         40.2     40.2      0.0          non_mcs_cloud_obj.longname = "non MCS cloud object defined by their Tb"
  5693         1         38.2     38.2      0.0          non_mcs_cloud_obj.unit = ""
  5694         1         15.6     15.6      0.0      if front_test == 'yes':
  5695         1         40.2     40.2      0.0          FR_real.coordinates = "lon lat"
  5696         1         40.2     40.2      0.0          FR_real.longname = "frontal index"
  5697         1         37.9     37.9      0.0          FR_real.unit = ""
  5698                                                   
  5699         1         39.6     39.6      0.0          FR_obj.coordinates = "lon lat"
  5700         1         39.2     39.2      0.0          FR_obj.longname = "frontal objects"
  5701         1         41.8     41.8      0.0          FR_obj.unit = ""
  5702                                                   
  5703         1         48.1     48.1      0.0          T_real.coordinates = "lon lat"
  5704         1         41.4     41.4      0.0          T_real.longname = "850 hPa air temperature"
  5705         1         38.6     38.6      0.0          T_real.unit = "K"
  5706         1         16.1     16.1      0.0      if slp_test == 'yes':
  5707         1         40.1     40.1      0.0          CY_obj.coordinates = "lon lat"
  5708         1         39.9     39.9      0.0          CY_obj.longname = "cyclone objects from SLP"
  5709         1         38.3     38.3      0.0          CY_obj.unit = ""
  5710                                                   
  5711         1         39.5     39.5      0.0          ACY_obj.coordinates = "lon lat"
  5712         1         39.5     39.5      0.0          ACY_obj.longname = "anticyclone objects from SLP"
  5713         1         38.0     38.0      0.0          ACY_obj.unit = ""
  5714                                                   
  5715         1         39.6     39.6      0.0          SLP_real.coordinates = "lon lat"
  5716         1         37.8     37.8      0.0          SLP_real.longname = "sea level pressure (SLP)"
  5717         1         37.9     37.9      0.0          SLP_real.unit = "Pa"
  5718         1         16.0     16.0      0.0      if ms_test == 'yes':
  5719         1         42.6     42.6      0.0          MS_real.coordinates = "lon lat"
  5720         1         41.9     41.9      0.0          MS_real.longname = "850 hPa moisture flux"
  5721         1         40.6     40.6      0.0          MS_real.unit = "g/g m/s"
  5722                                                   
  5723         1         41.6     41.6      0.0          MS_obj.coordinates = "lon lat"
  5724         1         40.9     40.9      0.0          MS_obj.longname = "mosture streams objects according to 850 hPa moisture flux"
  5725         1         40.5     40.5      0.0          MS_obj.unit = ""
  5726         1         16.5     16.5      0.0      if ar_test == 'yes':
  5727         1         39.5     39.5      0.0          IVT_real.coordinates = "lon lat"
  5728         1         43.4     43.4      0.0          IVT_real.longname = "vertically integrated moisture transport"
  5729         1         42.6     42.6      0.0          IVT_real.unit = "kg m−1 s−1"
  5730                                                   
  5731         1         42.7     42.7      0.0          IVT_obj.coordinates = "lon lat"
  5732         1         47.8     47.8      0.0          IVT_obj.longname = "IVT objects"
  5733         1         60.8     60.8      0.0          IVT_obj.unit = ""
  5734                                                   
  5735         1         42.9     42.9      0.0          ARs.coordinates = "lon lat"
  5736         1         41.8     41.8      0.0          ARs.longname = "atmospheric river objects"
  5737         1         39.2     39.2      0.0          ARs.unit = ""
  5738         1         16.2     16.2      0.0      if tc_test == 'yes':
  5739         1         41.1     41.1      0.0          TCs.coordinates = "lon lat"
  5740         1         39.0     39.0      0.0          TCs.longname = "tropical cyclone objects"
  5741         1         38.4     38.4      0.0          TCs.unit = ""
  5742         1         16.4     16.4      0.0      if z500_test == 'yes':
  5743         1         42.2     42.2      0.0          CY_z500_obj.coordinates = "lon lat"
  5744         1         41.8     41.8      0.0          CY_z500_obj.longname = "cyclone objects according to Z500"
  5745         1         41.2     41.2      0.0          CY_z500_obj.unit = ""
  5746                                                   
  5747         1         42.9     42.9      0.0          ACY_z500_obj.coordinates = "lon lat"
  5748         1         42.3     42.3      0.0          ACY_z500_obj.longname = "anticyclone objects according to Z500"
  5749         1         40.1     40.1      0.0          ACY_z500_obj.unit = ""
  5750                                                   
  5751         1         40.8     40.8      0.0          Z500_real.coordinates = "lon lat"
  5752         1         40.1     40.1      0.0          Z500_real.longname = "500 hPa geopotential height"
  5753         1         39.6     39.6      0.0          Z500_real.unit = "gpm"
  5754         1         16.6     16.6      0.0      if col_test == 'yes':
  5755         1         40.3     40.3      0.0          COL.coordinates = "lon lat"
  5756         1         40.6     40.6      0.0          COL.longname = "cut off low objects"
  5757         1         38.4     38.4      0.0          COL.unit = ""
  5758         1         16.9     16.9      0.0      if jet_test == 'yes':
  5759         1         40.6     40.6      0.0          JET.coordinates = "lon lat"
  5760         1         40.4     40.4      0.0          JET.longname = "jet stream objects"
  5761         1         38.9     38.9      0.0          JET.unit = ""
  5762                                                   
  5763         1         46.4     46.4      0.0          UV200.coordinates = "lon lat"
  5764         1         39.5     39.5      0.0          UV200.longname = "200 hPa wind speed"
  5765         1         41.0     41.0      0.0          UV200.unit = "m s-1"
  5766         1         22.7     22.7      0.0      if ew_test == 'yes':
  5767                                                   MRG.coordinates = "lon lat"
  5768                                                   MRG.longname = "Mixed Rosby Gravity wave objects"
  5769                                                   MRG.unit = ""
  5770                                                   
  5771                                                   IGW.coordinates = "lon lat"
  5772                                                   IGW.longname = "Inertia Gravity wave objects"
  5773                                                   IGW.unit = ""
  5774                                                   
  5775                                                   KELVIN.coordinates = "lon lat"
  5776                                                   KELVIN.longname = "Kelvin wave objects"
  5777                                                   KELVIN.unit = ""
  5778                                                   
  5779                                                   EIG.coordinates = "lon lat"
  5780                                                   EIG.longname = "Eastward Inertio Gravirt wave objects"
  5781                                                   EIG.unit = ""
  5782                                                   
  5783                                                   ER.coordinates = "lon lat"
  5784                                                   ER.longname = "Equatorial Rossby wave objects"
  5785                                                   ER.unit = ""
  5786                                           
  5787         1       3683.5   3683.5      0.0      lat[:] = Lat
  5788         1       3470.1   3470.1      0.0      lon[:] = Lon
  5789         1         20.3     20.3      0.0      if mcs_tb_test == 'yes':
  5790         1    1144387.1 1.14e+06      1.0          PR_real[:] = pr
  5791                                                   # PR_obj[:] = PR_objects
  5792                                                   # MCSs[:] = MCS_obj
  5793         1     461317.3 461317.3      0.4          MCSs_Tb[:] = MCS_objects_Tb
  5794         1    1995151.2    2e+06      1.7          Cloud_real[:] = tb
  5795                                                   # Cloud_obj[:] = C_objects
  5796         1         38.2     38.2      0.0      if cloud_test == 'yes':
  5797         1     500913.3 500913.3      0.4          non_mcs_cloud_obj[:] = cloud_objects
  5798         1         39.9     39.9      0.0      if front_test == 'yes':
  5799         1    2354017.3 2.35e+06      2.0          FR_real[:] = Frontal_Diagnostic
  5800         1     475035.2 475035.2      0.4          FR_obj[:] = FR_objects
  5801         1    2063315.0 2.06e+06      1.7          T_real[:] = t850
  5802         1         28.5     28.5      0.0      if tc_test == 'yes':
  5803         1     448937.1 448937.1      0.4          TCs[:] = TC_obj
  5804         1         24.7     24.7      0.0      if slp_test == 'yes':
  5805         1     470968.2 470968.2      0.4          CY_obj[:] = CY_objects
  5806         1     454488.3 454488.3      0.4          ACY_obj[:] = ACY_objects
  5807         1    2037615.3 2.04e+06      1.7          SLP_real[:] = slp
  5808         1         32.0     32.0      0.0      if ms_test == 'yes':
  5809         1    2257496.5 2.26e+06      1.9          MS_real[:] = VapTrans
  5810         1     452227.5 452227.5      0.4          MS_obj[:] = MS_objects
  5811         1         34.9     34.9      0.0      if ar_test == 'yes':
  5812         1    2267382.8 2.27e+06      1.9          IVT_real[:] = IVT
  5813         1     468975.5 468975.5      0.4          IVT_obj[:] = IVT_objects
  5814         1     463405.0 463405.0      0.4          ARs[:] = AR_obj
  5815         1         29.6     29.6      0.0      if z500_test == 'yes':
  5816         1     443773.2 443773.2      0.4          CY_z500_obj[:] = cy_z500_objects
  5817         1     444299.0 444299.0      0.4          ACY_z500_obj[:] = acy_z500_objects
  5818         1    2095601.2  2.1e+06      1.8          Z500_real[:] = z500
  5819         1         26.1     26.1      0.0      if col_test == 'yes':
  5820         1     460973.6 460973.6      0.4          COL[:] = col_obj
  5821         1         24.9     24.9      0.0      if jet_test == 'yes':
  5822         1     501827.1 501827.1      0.4          JET[:] = jet_objects
  5823         1    2170576.3 2.17e+06      1.8          UV200[:] = uv200
  5824         1         28.2     28.2      0.0      if ew_test == 'yes':
  5825                                                   MRG[:] = mrg_objects
  5826                                                   IGW[:] = igw_objects
  5827                                                   KELVIN[:] = kelvin_objects
  5828                                                   EIG[:] = eig0_objects
  5829                                                   ER[:] = er_objects
  5830                                                           
  5831         1        768.0    768.0      0.0      times[:] = iTime
  5832                                               
  5833                                               # SET GLOBAL ATTRIBUTES
  5834                                               # Add global attributes
  5835         1    4585470.9 4.59e+06      3.8      dataset.title = "MOAAP object tracking output"
  5836         1        257.9    257.9      0.0      dataset.contact = "Andreas F. Prein (prein@ucar.edu)"
  5837                                               # dataset.breakup = 'The ' + breakup + " method has been used to segment the objects"
  5838                                           
  5839         1     109258.9 109258.9      0.1      dataset.close()
  5840         1         34.7     34.7      0.0      print('Saved: '+NCfile)
  5841         1         24.9     24.9      0.0      import time
  5842         1         22.3     22.3      0.0      end = time.perf_counter()
  5843         1         49.7     49.7      0.0      timer(start, end)
  5844                                           
  5845         1         20.2     20.2      0.0      if tc_test == 'yes':
  5846                                                   ### SAVE THE TC TRACKS TO PICKL FILE
  5847                                                   # ============================
  5848         1        268.8    268.8      0.0          a_file = open(params["OutputFolder"]+str(Time[0].year)+str(Time[0].month).zfill(2)+'_TCs_tracks.pkl', "wb")
  5849         1         26.9     26.9      0.0          pickle.dump(TC_Tracks, a_file)
  5850         1         67.1     67.1      0.0          a_file.close()
  5851                                                   
  5852         1         48.8     48.8      0.0      if 'object_split' in locals():
  5853         1         10.8     10.8      0.0          return object_split
  5854                                               else:
  5855                                                   object_split = None
  5856                                                   return object_split

Total time: 127.699 s
File: 2d_vs_3d.py
Function: main at line 9

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     9                                           @profile
    10                                           def main():
    11         2          2.3      1.1      0.0    object_names = [['cold clouds', '#737373', '-', 2],
    12         1          0.8      0.8      0.0                    ['surface cyclones', 'k', '-', 2],
    13         1          0.5      0.5      0.0                    ['mid-level cyclones', 'k', '--', 2],
    14         1          0.6      0.6      0.0                    ['anticyclones', '#ff7f00', '-', 2],
    15         1          0.6      0.6      0.0                    ['MCS', '#33a02c', '-', 2],
    16         1          0.7      0.7      0.0                    ['moisture streams', 'r', '-', 2],
    17         1          0.5      0.5      0.0                    ['jets', '#6a3d9a', '-', 2],
    18         1          0.5      0.5      0.0                    ['Rossby waves', '#8c510a', '-', 3],
    19         1          0.5      0.5      0.0                    ['mixed Rossby gravity waves', '#bf812d', '-', 1.5],
    20         1          0.5      0.5      0.0                    ['inertia gravity waves', '#dfc27d','-', 3],
    21         1          0.6      0.6      0.0                    ['Kelvin waves', '#abd9e9','-', 1.5],
    22         1          0.6      0.6      0.0                    ['eastward inertia gravity waves', '#4575b4', '-', 3],
    23         1          0.4      0.4      0.0                    ['fronts', '#cab2d6', '-', 2]]
    24                                           
    25                                           
    26         1    2335113.9 2.34e+06      1.8    data_vars = xr.open_dataset('20210701-04_MOAAP-Input_24h.nc')
    27                                           
    28         1          0.9      0.9      0.0    dT = 1 # time interval of input files [hours]
    29         1      13014.9  13014.9      0.0    Mask = np.copy(data_vars['lon']); Mask[:]=1 # tracking is applied globally
    30         1          1.5      1.5      0.0    DataName = 'ERA5'
    31         1       1972.3   1972.3      0.0    time_datetime = pd.to_datetime(np.array(data_vars['time'].values, dtype='datetime64'))
    32                                           
    33        18  119273619.3 6.63e+06     93.4    object_split = moaap(
    34         1        114.6    114.6      0.0                          data_vars['lon'],
    35         1         86.9     86.9      0.0                          data_vars['lat'],
    36         1          0.5      0.5      0.0                          time_datetime,
    37         1          0.5      0.5      0.0                          dT,
    38         1          0.5      0.5      0.0                          Mask,
    39         1     209450.5 209450.5      0.2                          v850 =  data_vars['V850'].values,
    40         1     196719.4 196719.4      0.2                          u850 = data_vars['U850'].values,
    41         1     163161.4 163161.4      0.1                          t850 = data_vars['T850'].values,
    42         1     209253.7 209253.7      0.2                          q850 = data_vars['Q850'].values,
    43         1    1482449.8 1.48e+06      1.2                          slp = data_vars['SLP'].values,
    44         1     241796.5 241796.5      0.2                          ivte = data_vars['IVTE'].values,
    45         1     248568.6 248568.6      0.2                          ivtn = data_vars['IVTN'].values,
    46         1     250447.5 250447.5      0.2                          z500 = data_vars['Z500'].values,
    47         1     283617.6 283617.6      0.2                          v200 = data_vars['V200'].values,
    48         1     279230.6 279230.6      0.2                          u200 = data_vars['U200'].values,
    49                                                                   # v850 =None, #  data_vars['V850'],
    50                                                                   # u850 = None, #data_vars['U850'],
    51                                                                   # t850 = None, #data_vars['T850'],
    52                                                                   # q850 = None, #data_vars['Q850'],
    53                                                                   # slp = None, #data_vars['SLP'],
    54                                                                   # ivte = None, #data_vars['IVTE'],
    55                                                                   # ivtn = None, #data_vars['IVTN'],
    56                                                                   # z500 = None, #data_vars['Z500'],
    57                                                                   # v200 = None, #data_vars['V200'],
    58                                                                   # u200 = None, #data_vars['U200'],
    59         1     267529.5 267529.5      0.2                          pr   = data_vars['PR'].values,
    60         1     277936.0 277936.0      0.2                          tb   = data_vars['Tb'].values,
    61         1          1.3      1.3      0.0                          DataName = DataName,
    62         1          1.2      1.2      0.0                          OutputFolder = 'moaap_output/',
    63         1          1.2      1.2      0.0                          js_min_anomaly = 12,
    64         1          0.9      0.9      0.0                          MinTimeJS = 12,
    65                                                                     )
    66                                           
    67                                           
    68         1      32999.2  32999.2      0.0    data_moaap = xr.open_dataset('moaap_output/202107_ERA5_ObjectMasks__dt-1h_MOAAP-masks.nc')
    69         1          2.4      2.4      0.0    import pickle
    70         2         38.9     19.4      0.0    with open('moaap_output/MCSs_202107__dt-1h_MOAAP-masks.pkl', 'rb') as f:
    71         1       3381.0   3381.0      0.0        mcs_charac = pickle.load(f)
    72                                           
    73         1          4.8      4.8      0.0    import cartopy.crs as ccrs
    74         1          4.6      4.6      0.0    import matplotlib.pyplot as plt
    75                                           
    76                                             # Create a figure and axis with a PlateCarree projection (latitude and longitude)
    77         2     416103.0 208051.5      0.3    fig, ax = plt.subplots(subplot_kw={'projection': ccrs.PlateCarree()},
    78         1          0.8      0.8      0.0                          figsize=(14,6))
    79                                           
    80                                             # Set the extent of the map (in this case, the entire globe)
    81         1       2015.9   2015.9      0.0    ax.set_extent([-180, 180, -90, 90], crs=ccrs.PlateCarree())
    82                                           
    83                                             # Add coastlines and gridlines for reference
    84         1       1636.9   1636.9      0.0    ax.coastlines(color='#969696')
    85         1       6276.9   6276.9      0.0    ax.gridlines()
    86                                           
    87                                             # Generate some random data (latitude, longitude, and values)
    88         1      10838.6  10838.6      0.0    mcs_mask = np.array(data_moaap['MCS_Tb_Objects'][12,:,:])
    89         1       1629.5   1629.5      0.0    mcs_mask[mcs_mask == 0] = np.nan
    90         2     468951.8 234475.9      0.4    sc = plt.pcolormesh(data_moaap['lon'],
    91         1        117.2    117.2      0.0                        data_moaap['lat'],
    92         1          0.8      0.8      0.0                        mcs_mask,
    93         1          0.6      0.6      0.0                        cmap = 'nipy_spectral')
    94                                           
    95                                           
    96                                             # plot MCS tracks
    97       101         96.0      1.0      0.0    for ii in range(len(mcs_charac.keys())):
    98       100        303.1      3.0      0.0      LatLonTrack = mcs_charac[list(mcs_charac.keys())[ii]]['track']
    99       100     203844.3   2038.4      0.2      plt.plot(LatLonTrack[:,1],LatLonTrack[:,0], transform=ccrs.PlateCarree(), lw=1, color='k')
   100                                           
   101         1      20074.7  20074.7      0.0    ax.set_extent([-180, 180, -70, 70], crs=ccrs.PlateCarree())
   102                                           
   103                                             # Add a colorbar to the plot
   104         1      51566.0  51566.0      0.0    cbar = plt.colorbar(sc, ax=ax, orientation='vertical', shrink=0.7, label='MCS mask')
   105                                           
   106                                             # Set the title of the plot
   107         1        762.0    762.0      0.0    plt.title('MCS tracks (black lines) and masks at '+str(time_datetime[12])[:16])
   108                                           
   109         1     744157.8 744157.8      0.6    plt.savefig("MCS_tracks_masks_3d.png")
   110                                           
   111         1          0.9      0.9      0.0    print_gif = False
   112         1          6.2      6.2      0.0    if print_gif:
   113                                               for tt in tqdm(range(len(time_datetime))):
   114                                           
   115                                                 # Create a figure and axis with a PlateCarree projection (latitude and longitude)
   116                                                 fig, ax = plt.subplots(subplot_kw={'projection': ccrs.PlateCarree()},
   117                                                                       figsize=(14,6))
   118                                           
   119                                                 # Set the extent of the map (in this case, the entire globe)
   120                                                 # ax.set_extent([-180, 180, -90, 90], crs=ccrs.PlateCarree())
   121                                           
   122                                                 # Add coastlines and gridlines for reference
   123                                                 ax.coastlines(color='#969696')
   124                                                 ax.gridlines()
   125                                           
   126                                                 # Define mapping of object types to colors/styles
   127                                                 object_plotting_config = {
   128                                                     'MCS_Tb_Objects': {'colors': '#33a02c', 'threshold': 0, 'linewidth': 1},
   129                                                     'CY_Objects': {'colors': 'k', 'threshold': 0, 'linewidth': 1},
   130                                                     'COL_Objects': {'colors': 'k', 'threshold': 0, 'linewidth': 1, 'linestyles': '--'},
   131                                                     'ACY_Objects': {'colors': '#ff7f00', 'threshold': 0, 'linewidth': 1},
   132                                                     'JET_Objects': {'colors': '#6a3d9a', 'threshold': 0, 'linewidth': 1},
   133                                                     'AR_Objects': {'colors': 'r', 'threshold': 0, 'linewidth': 1},
   134                                                     'FR_Objects': {'colors': '#cab2d6', 'threshold': 1, 'linewidth': 0.5},
   135                                                     'ER_Objects': {'colors': '#8c510a', 'threshold': 1, 'linewidth': 0.5}
   136                                                 }
   137                                           
   138                                                 # Plot only available objects
   139                                                 for obj_name, config in object_plotting_config.items():
   140                                                     if obj_name in data_moaap.data_vars:
   141                                                         plot_args = {
   142                                                             'colors': config['colors'],
   143                                                             'levels': range(0, 2, 1),
   144                                                             'linewidths': config.get('linewidth', 1)
   145                                                         }
   146                                                         if 'linestyles' in config:
   147                                                             plot_args['linestyles'] = config['linestyles']
   148                                                             
   149                                                         sc = plt.contour(data_moaap['lon'],
   150                                                                         data_moaap['lat'],
   151                                                                         np.array(data_moaap[obj_name][tt,:,:]) > config['threshold'],
   152                                                                         **plot_args)
   153                                           
   154                                                 # Set the title of the plot
   155                                                 plt.title('Objects identied by MOAAP at '+str(time_datetime[tt])[:16])
   156                                           
   157                                                 # create legend
   158                                                 for ob in range(len(object_names)):
   159                                                   plt.plot([],[], color = object_names[ob][1], \
   160                                                           linestyle = object_names[ob][2],\
   161                                                           lw = object_names[ob][3],\
   162                                                           label = object_names[ob][0])
   163                                           
   164                                                 # plt.legend()
   165                                                 ax.legend(bbox_to_anchor=(1, 0.00), ncol=4)
   166                                           
   167                                           
   168                                                 # Show the plot
   169                                                 fig.savefig('images/'+str(tt).zfill(3)+'_CausesOfExtreme_100_daily-extremes.jpg', bbox_inches='tight', dpi=100)
   170                                           
   171                                                 import glob
   172                                           
   173                                                 from PIL import Image
   174                                                 def make_gif(frame_folder):
   175                                                     frames = [Image.open(image) for image in np.sort(glob.glob(f"{frame_folder}/*.jpg"))]
   176                                                     frame_one = frames[0]
   177                                                     frame_one.save("phenomenon.gif", format="GIF", append_images=frames,
   178                                                             save_all=True, duration=100, loop=0)
   179                                           
   180                                                 make_gif("images/")

Based on the line_profiler output, the biggest bottlenecks are:

watershed_3d_overlap function in Tracking_Functions.py: This function takes 30.0608 s.
Specifically, the line watershed_results = watershed(...) consumes 70.9% of the time within this function.
The call to label_peaks_over_time_3d takes 3.8% of the time.
moaap function in Tracking_Functions.py: This function takes 119.236 s.
The call to jetstream_tracking takes 24.7% of the time.
The watershedding in the jetstream_tracking function is likely the bottleneck.
main function in 2d_vs_3d.py: This function takes 127.699 s.
The call to moaap consumes 93.4% of the time within this function.
In summary, the watershedding process within watershed_3d_overlap and jetstream_tracking and the moaap function are the most significant performance bottlenecks.
Optimizing these areas would likely yield the greatest improvements in overall runtime.